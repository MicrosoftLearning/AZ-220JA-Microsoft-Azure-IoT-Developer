---
lab:
    title: 'ラボ 05: DPS のデバイスの個別登録'
    module: 'モジュール 3: 大規模なデバイス プロビジョニング'
---

# DPS でのデバイスの個別登録

## ラボ シナリオ

Contoso の経営陣は、IoT デバイスを使用して現在のシステムで必要な手動のデータ入力作業を削減し、出荷プロセス時により高度な監視機能を提供する、自社の資産の監視および追跡ソリューションの更新を強く要求しています。このソリューションは、IoT デバイスのプロビジョニングとプロビジョニング解除を行う機能に依存しています。プロビジョニング要件を管理するための最良の選択肢は DSP のようです。

提案されたシステムは、輸送中の輸送コンテナーの場所、温度、圧力をトラッキングするために、統合されたセンサーを備えた IoT デバイスを使用します。デバイスは、Contoso がチーズの輸送に使用する既存の出荷コンテナー内に配置され、車両が提供する WiFi を使用して Azure IoT Hub に接続します。新しいシステムは、製品環境の継続的な監視を提供し、問題が検出されたときにさまざまな通知シナリオを可能にします。

Contoso のチーズ パッケージング施設では、空のコンテナーがシステムに入ると、新しい IoT デバイスが装備され、パッケージ化されたチーズ製品がロードされます。IoT デバイスは、デバイス プロビジョニング サービスを使用して IoT ハブに自動プロビジョニングする必要があります。コンテナーが宛先に到着すると、IoT デバイスが取得され、DPS を通じて "使用停止" されます。デバイスは、今後の出荷に再利用されます。

DPS を使用してデバイス プロビジョニングとプロビジョニング解除プロセスを検証する作業を担当します。プロセスの初期段階では、個別登録アプローチを使用します。

次のリソースが作成されます。

![ラボ 5 アーキテクチャ](media/LAB_AK_05-architecture.png)

## このラボでは

このラボでは、次のタスクを完了します。

* ラボの前提条件が満たされていることを確認する (必要な Azure リソースがあること)
* DPS での新しい個人登録の作成
* シミュレートされたデバイスの構成
* シミュレートされたデバイスのテスト
* デバイスの削除

## ラボの手順

### 演習 1: ラボの前提条件を確認する

このラボでは、次の Azure リソースが使用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| デバイス プロビジョニング サービス | AZ-220-DPS-_{YOUR-ID}_ |

これらのリソースが利用できない場合は、演習 2 に進む前に、以下の手順に従って **lab05-setup.azcli** スクリプトを実行する必要があります。スクリプト ファイルは、開発環境構成 (ラボ 3) の一部としてローカルに複製した GitHub リポジトリに含まれています。

**lab05-setup.azcli** スクリプトは、**Bash** シェル環境で動作するように記述されています。これは、Azure Cloud Shell で実行するのが最も簡単です。

1. ブラウザーを使用して [Azure Cloud Shell](https://shell.azure.com/) を開き、このコースで使用している Azure サブスクリプションでログインします。

    Cloud Shell のストレージの設定に関するメッセージが表示された場合は、デフォルトをそのまま使用します。

1. Azure Cloud Shell が **Bash** を使用していることを確認 します。

    「Azure Cloud Shell」 ページの左上隅にあるドロップダウンは、環境を選択するために使用されます。選択されたドロップダウンの値が **Bash**であることを確認します。 

1. Azure Shell ツール バーで、「**ファイルのアップロード/ダウンロード**」 をクリックします (右から 4 番目のボタン)。

1. ドロップダウンで、「**アップロード**」 をクリックします。

1. ファイル選択ダイアログで、開発環境を構成したときにダウンロードした GitHub ラボ ファイルのフォルダーの場所に移動します。

    _ラボ 3: 開発環境の設定_:ZIP ファイルをダウンロードしてコンテンツをローカルに抽出することで、ラボ リソースを含む GitHub リポジトリを複製しました。抽出されたフォルダー構造には、次のフォルダー パスが含まれます。

    * Allfiles
      * ラボ
          * 05 - DPS におけるデバイスの個別登録
            * セットアップ

    lab05-setup.azcli スクリプト ファイルは、ラボ 5 の設定 フォルダー内にあります。

1. **lab05-setup.azcli** ファイルを選択し、「**開く**」 をクリックします。

    ファイルのアップロードが完了すると、通知が表示されます。

1. 正しいファイルがアップロードされたことを確認するには、次のコマンドを入力します。

    ```bash
    ls
    ```

    `ls` コマンドを実行すると、現在のディレクトリの内容が一覧表示されます。lab05-setup.azcli ファイルが一覧表示されます。

1. セットアップ スクリプトを含むディレクトリをこのラボ用に作成し、そのディレクトリに移動するには、次の Bash コマンドを入力します。

    ```bash
    mkdir lab5
    mv lab05-setup.azcli lab4
    cd lab5
    ```

    これらのコマンドは、このラボのディレクトリを作成し、そのディレクトリに **lab05-setup.azcli** ファイルを移動して、新しいディレクトリを現在の作業ディレクトリに変更します。

1. **lab05-setup.azcli** スクリプトに実行権限があることを確認するには、次のコマンドを入力します。

    ```bash
    chmod +x lab05-setup.azcli
    ```

1. Cloud Shell ツール バーで、lab06-setup.azcli ファイルを編集するには、「**エディターを開く**」 (右から 2 番目のボタン - **{ }**) をクリックします。 

1. 「**ファイル**」 の一覧で、lab6 フォルダーを展開してスクリプト ファイルを開き 、**lab5**、「**lab05-setup.azcli**」 の順にクリックします。

    エディターで **lab05-setup.azcli** ファイルの内容を表示します。

1. エディターで、`{YOUR-ID}` と `{YOUR-LOCATION}` 変数の値を更新します。

    サンプル例として、このコースの最初に作成した一意の ID 、つまり **CAH191211** に `{YOUR-ID}` を設定し、リソースにとって意味のある場所に `{YOUR-LOCATION}` を設定する必要があります。

    ```bash
    #!/bin/bash

    RGName="AZ-220-RG"
    IoTHubName="AZ-220-HUB-{YOUR-ID}"

    Location="{YOUR-LOCATION}"
    ```

    > **注意**:  `{YOUR-LOCATION}` 変数は、リージョンの短い名前に設定する必要があります。次のコマンドを入力すると、使用可能な領域とその短い名前 (**名前** 列) の一覧を表示できます。
    >
    > ```bash
    > az account list-locations -o Table
    >
    > DisplayName           Latitude    Longitude    Name
    > --------------------  ----------  -----------  ------------------
    > East Asia             22.267      114.188      eastasia
    > Southeast Asia        1.283       103.833      southeastasia
    > Central US            41.5908     -93.6208     centralus
    > East US               37.3719     -79.8164     eastus
    > East US 2             36.6681     -78.3889     eastus2
    > ```

1. エディター画面の右上で、ファイルに加えた変更を保存してエディタを閉じるには、**..** をクリックし、**エディタを閉じる** をクリックします。 

    保存を求められたら、**保存** をクリックすると、エディタが閉じます。 

    > **注意**:  **CTRL+S** を使っていつでも保存でき、 **CTRL+Q** を押してエディターを閉じます。

1. この実習ラボに必要なリソースを作成するには、次のコマンドを入力します。

    ```bash
    ./lab05-setup.azcli
    ```

    これは、実行するのに数分かかります。各ステップが完了すると、JSON 出力が表示されます。

    スクリプトが完了したら、ラボを続行できます。

### 演習 2: DPS での新しい個別登録 (対称キー) の作成

この演習では、_対称キー構成証明_を使用して、デバイス プロビジョニング サービス (DPS) 内のデバイスに対して新しい個別登録を作成します。

#### タスク 1: 登録の作成

1. 必要に応じて、Azure アカウントの認証情報を使用して Azure portal にログインします。

    複数の Azure アカウントをお持ちの場合は、このコースで使用するサブスクリプションに関連付けられているアカウントでログインしていることを確認してください。

1. 前のタスクで作成した **AZ-220** ダッシュボードが読み込まれています。

    IoT ハブと DPS の両方のリソースが表示されます。

1. リソース グループ タイルで、「**AZ-220-DPS-_{YOUR-ID}_**」 をクリックします。

1. 左側の 「**デバイス プロビジョニング サービス の設定**」 ペインで、「**登録の管理**」 をクリックします。

1. ペインの上部にある 「**+ 個別の登録を追加**」 をクリックします。

1. 「**登録の追加**」 ブレードの 「**メカニズム**」 ドロップダウンで、「**対称キー**」 をクリックします。

    これにより、対称キー認証を使用する構成証明方法が設定されます。

1. 「メカニズム」 設定のすぐ下で、「**キーの自動生成**」 オプションがオンになっていることを確認します。

    これにより、DPS は デバイス登録時に **主キー** と **2 次キー** の両方の値を自動的に生成するように設定されます。オプションで、このオプションのチェックを外して、カスタムキーを手動で入力できます。

1. 「**登録 ID**」 フィールドで、DPS 内のデバイス登録に使用する登録 ID を指定するには 「**DPSSimulatedDevice1**」 と入力します 

    既定では、登録からデバイスがプロビジョニングされるときに、登録 ID が IoT ハブデバイス ID として使用されます。これらの値を異なる値にする必要がある場合は、そのフィールドに必要な IoT ハブデバイス ID を入力します。

1. 「**IoT ハブ デバイス ID**」 フィールドは空白のままにします。 

    このフィールドを空白のままにすると、IoT ハブは登録 ID をデバイス ID として使用します。選択できないフィールドにデフォルトのテキスト値が表示される場合は、このテキストはプレースホルダー テキストであり、入力値として扱われるので、心配しないでください。

1. 「**IoT Edge デバイス**」 フィールドを **False** のままにします。   

   新しいデバイスはエッジ デバイスではありません。IoT Edge デバイスの操作については、このコースの後半で説明します。

1. 「**デバイスをハブに割り当てる方法を選択してください**」 フィールドを 「**加重が均等に分布**」 に設定したままにします。   

   登録に関連付けられている IoT ハブは 1 つしかないため、この設定は重要ではありません。  複数の分散ハブがある大規模な環境では、この設定によって、このデバイス登録を受信する IoT ハブの選択方法を制御できます。サポートされている割り当てポリシーは 4 つあります。

    * **最低限の待ち時間**: デバイスは、デバイスに対する待ち時間が最も低いハブに基づいて IoT ハブにプロビジョニングされます。
    * **加重が均等に分布 (デフォルト)**: リンクされた IoT ハブは、デバイスがプロビジョニングされている可能性が同じになります。これがデフォルトの設定です。デバイスを 1 つの IoT ハブのみにプロビジョニングする場合、この設定を維持できます。 
    * **登録リストを介した静的構成**: 登録リストで必要な IoT ハブの仕様は、デバイス プロビジョニング サービス レベルの割り当てポリシーよりも優先されます。
    * **カスタム (Azure 関数を使用)**: デバイス プロビジョニング サービスは、デバイスと登録に関するすべての関連情報を提供する Azure 関数コードを呼び出します。関数コードが実行され、デバイスのプロビジョニングに使用される IoT ハブ情報が返されます。

1. 「**このデバイスを割り当てることができる IoT ハブを選択する**」 ドロップダウンで 作成した **AZ-220-HUB-_{YOUR-ID}_** IoT ハブが指定されていることに注意してください。

   このフィールドは、_DPSSimulatedDevice1_ デバイスに割り当てられる IoT ハブを指定するために使用されます。

1. 「**Select how you want device data to be handled on re-provisioning (再プロビジョニングするときのデバイス データの処理方法を選択してください)**」 フィールドを、既定値の 「**Re-provision and migrate data (再プロビジョニングしてデータを移行する)**」 に設定したままにします。

    このフィールドによって、同じデバイス (同じ登録 ID で示される) が、少なくとも 1 回正常にプロビジョニングされた後に、プロビジョニング要求を後で送信する再プロビジョニング動作を高度に制御できます。次の 3 つのオプションがあります。

    * **データの再プロビジョニングと移行**: このポリシーは、新しい登録エントリの既定です。このポリシーは、登録エントリに関連付けられているデバイスが新しいプロビジョニング要求を送信するときにアクションを実行します。登録エントリの構成によっては、デバイスが別の IoT ハブに再割り当てされる場合があります。デバイスが IoT ハブを変更する場合は、最初の IoT ハブを使用したデバイスの登録が削除されます。その初期 IoT ハブからのすべてのデバイス状態の情報は、新しい IoT ハブに移行されます。
    * **再プロビジョニングして初期構成にリセットする**: このポリシーは、IoT ハブを変更せずに工場出荷時のリセットに使用されることがよくあります。このポリシーは、登録エントリに関連付けられているデバイスが新しいプロビジョニング要求を送信するときにアクションを実行します。登録エントリの構成によっては、デバイスが別の IoT ハブに再割り当てされる場合があります。デバイスが IoT ハブを変更する場合は、最初の IoT ハブを使用したデバイスの登録が削除されます。デバイスがプロビジョニングされたときにプロビジョニング サービス インスタンスが受信した初期構成データが、新しい IoT ハブに提供されます。
    * **再プロビジョニングを行わない**: デバイスが別のハブに再割り当てされることはありません。このポリシーは、下位互換性を管理するために用意されています。

1. 「**初期デバイス ツイン状態**」 フィールドで、`properties.desired` JSON オブジェクトを変更して、`telemetryDelay` という名前のプロパティを値 `2` で指定します。 

    最終的な JSON は次のようになります。

    ```json
    {
        "tags": {},
        "properties": {
            "desired": {
                "telemetryDelay": "2"
            }
        }
    }
    ```

    このフィールドには、デバイスの必要なプロパティの初期構成を表す JSON データが含まれます。入力したデータは、センサー テレメトリの読み取りと IoT ハブへのイベントの送信の遅延時間を設定するためにデバイスによって使用されます。

1. 「**入力可能な項目**」 フィールドは 「**有効**」 に設定したままにします。   

    一般的に、新しい登録エントリを有効にし、有効を維持する必要があります。

1. 「**登録の追加**」 ブレードの上部にある 「**保存**」 をクリック します。

#### タスク 2: 登録を検証する

1. 「**登録の管理**」 ブレードで、個別のデバイス登録の一覧を表示するには、「**個別の登録**」 をクリックします。   

1. 「個別の登録」 で 「**DPSSimulatedDevice1**」 をクリックします。

    これにより、作成した個々の登録の登録詳細を表示できます。

1. 「**認証タイプ**」 セクションを見つけ、 **メカニズム**が**対称キー**に設定されていることに注意してください。     

1. このデバイスの登録の**主キー**と **2 次キー**の値をコピーし (この目的のために各テキスト ボックスの右側にボタンがあります)、後で参照できるように保存します。

    これらは、デバイスがサービスで認証するための認証キーです。

1. **初期デバイス ツインの状態**を見つけ、デバイス ツインの Desired State の JSON に、`telemetryDelay` プロパティが値 `2` に設定されていることに注意してください。 

1. 「**DPSSimulatedDevice1**」 ビューを閉じて、「**AZ-220-DPS-_{YOUR-ID}_**」 ブレードに戻ります。   

### 演習 3: シミュレートされたデバイスの構成

この演習では、前の単元で作成した個々の登録を使用して Azure IoT に接続するように、C# で記述されたシミュレートされたデバイスを構成します。また、Azure IoT Hub 内のデバイス ツインに基づくデバイス構成を読み取って更新するコードをシミュレートされたデバイスに追加します。

この演習で作成するシミュレートされたデバイスは、出荷コンテナーやボックス内に配置される IoT デバイスを表し、Contoso 製品の転送中の監視に使用されます。Azure IoT Hub に送信されるデバイスからのセンサー テレメトリには、コンテナーの温度、湿度、圧力、緯度/経度座標が含まれています。デバイスは、全体的な資産追跡ソリューションの一部です。

これは、シミュレートされたデバイスが Azure に接続された以前のラボとは異なります。そのラボでは認証に共有アクセス キーを使用してデバイスのプロビジョニングを必要とせず、プロビジョニング管理の利点 (デバイス ツインなど) も提供しないためです。また、共有キーのかなり大希望な配布と管理が必要です。  このラボでは、デバイス プロビジョニング サービスを使用して一意のデバイスをプロビジョニングします。

#### タスク 1: シミュレートされたデバイスを作成する

1. **AZ-220-DPS-_{YOUR-ID}_** ブレードで、「**概要**」 ペインに移動します。   

1. ブレードの右上で、ID スコープに割り当てられた値の上にマウス ポインタを置き、「**クリップボードにコピー**」 をクリックします。 

    この値はまもなく使用されるため、クリップボードを使用できない場合は値をメモしておきます。大文字の "O" と数字の "0" を必ず区別してください。

    **ID スコープ**は、次の値と似ています。  `0ne0004E52G`

1. **Visual Studio Code** を使用して、ラボ 5 のスターター フォルダーを開きます。

    ここでも、これはラボ 3 で開発環境を設定するときにダウンロードしたラボ リソース ファイルを指しています。フォルダ パスは次のとおりです。

    * Allfiles
      * ラボ
          * 05 - DPS におけるデバイスの個別登録
            * スターター

1. 「**表示**」 メニューの 「**ターミナル**」 をクリックします。   

    選択したターミナル シェルが Windows コマンド プロンプトであることを確認します。

1. コマンド ラインを使用して NuGet パッケージのすべてのアプリケーションを復元するには、ターミナル ビューのコマンド プロンプトで次のコマンドを入力します。

    ```cmd/sh
    dotnet restore
    ```

1. 「Visual Studio Code Explorer」 ペインで、「**Program.cs**」 をクリックします。 

1. コード エディターで、プログラム クラスの上部にある `dpsIdScope` 変数を見つけて、Azure portal のデバイス プロビジョニング サービスからコピーした ID スコープ値を使用して割り当てられた値を更新します。

    > **注意**: ID スコープの値が使用できない場合は、DPS サービスの 「概要」 ブレード (Azure portal) で確認できます。

1. `registrationId` 変数を見つけて、値を **DPSSimulatedDevice1** に置き換えます

    この変数は、デバイス プロビジョニング サービスで作成した個々の加入契約の **登録 ID** 値を表します。

1. `individualEnrollmentPrimaryKey` と `individualEnrollmentSecondaryKey` 変数を見つけて、それらの値をシミュレートされたデバイスの個々の登録を構成するときに保存した**主キー**と **2 次キー**の値に置き換えます。

    > **注意**: これらのキー値が利用できない場合は、次のように Azure portal からコピーできます。
    >
    > 「**登録の管理**」 ブレードを開き、「**個別の登録**」 をクリックし、「**DPSSimulatedDevice1**」 をクリックします。値をコピーし、上記の手順に示すように貼り付けます。

1. シミュレートされたデバイスのソース コードを確認し、次の項目に着目してください。

    * `ProvisioningDeviceLogic` クラスには、シミュレートされたデバイス センサーから読み取るためのロジックが含まれています。
    * `ProvisioningDeviceLogic.SendDeviceToCloudMessagesAsync` メソッドには、温度、湿度、圧力、緯度、経度用の、シミュレートされたセンサーの読み取り値を生成するためのロジックが含まれています。このメソッドはまた、テレメトリをデバイスからクラウドへのメッセージとして Azure IoT Hub に送信します。

1. `ProvisioningDeviceLogic.SendDeviceToCloudMessagesAsync`メソッドの下部にある `Task.Delay` の呼び出しに着目してください。

    `Task.Delay` は、次のテレメトリ メッセージを作成して送信する前に、一定期間 `while` ループを "一時停止" するために使用されます。`_telemetryDelay` 変数は、次のテレメトリ メッセージを送信するまでの待機時間を定義するために使用されます。

1. `ProvisioningDeviceLogic` クラスの先頭近くにある `_telemetryDelay` 変数宣言を見つけます。

    遅延の既定値が `1` 秒に設定されていることに注意してください。次の手順では、デバイス ツイン値を使用して遅延時間を制御するコードを統合します。

#### タスク 2: デバイス ツインのプロパティを統合する

デバイスで (Azure IoT Hub から) デバイス ツインのプロパティを使用するには、デバイス ツインのプロパティにアクセスして適用するコードを作成する必要があります。この場合、シミュレートされたデバイス コードを更新してデバイス ツインの必要なプロパティを読み取ってから、その値を `_telemetryDelay` 変数に割り当てます。また、現在デバイスに実装されている遅延値を示すために、デバイス ツインの報告されるプロパティを更新します。

1. Visual Studio Code エディターで、`RunAsync` メソッドを見つけます。

1. コードを確認してから、`// TODO: を見つけてください。OnDesiredPropertyChanged Event Handling` コメントをセットアップします。

    デバイス ツイン プロパティの統合を開始するには、デバイス ツイン プロパティが更新されたときに、シミュレートされたデバイスに通知を有効にするコードが必要です。

    これを実現するには、`DeviceClient.SetDesiredPropertyUpdateCallbackAsync` メソッドを使用し、`OnDesiredPropertyChanged` イベントを作成することによってイベント ハンドラーを設定します。

1. OnDesiredPropertyChanged イベントの DeviceClient を設定するには、`// TODO 1:` コメントを次のコードに置き換えます。

    ```csharp
    Console.WriteLine("Connecting SetDesiredPropertyUpdateCallbackAsync event handler...");
    await iotClient.SetDesiredPropertyUpdateCallbackAsync(OnDesiredPropertyChanged, null).ConfigureAwait(false);
    ```

    疑問に思っているかもしれませんが、ProvisioningDeviceLogic クラスの先頭に、DeviceClient `iotClient` インスタンスを作成しました。

    次に、`OnDesiredPropertyChanged` メソッドを `ProvisioningDeviceLogic` クラスに追加する必要があります。

1. イベント ハンドラーの設定を完了するには、次のメソッド コードを ProvisioningDeviceLogic クラスに追加します。

    > **注意**: このコードは `RunAsync` メソッドの下に配置できます (そうすれば、更新する他のコードの近くになります)。

    ```csharp
    private async Task OnDesiredPropertyChanged(TwinCollection desiredProperties, object userContext)
    {
        Console.WriteLine("Desired Twin Property Changed:");
        Console.WriteLine($"{desiredProperties.ToJson()}");

        // 必要なツイン プロパティを読み取る
        if (desiredProperties.Contains("telemetryDelay"))
        {
            string desiredTelemetryDelay = desiredProperties「"telemetryDelay"」;
            if (desiredTelemetryDelay != null)
            {
                this._telemetryDelay = int.Parse(desiredTelemetryDelay);
            }
            // 必要な telemetryDelay が null または未指定の場合は、変更しないでください
        }


        // ツイン プロパティをレポートする
        var reportedProperties = new TwinCollection();
        reportedProperties「"telemetryDelay"」 = this._telemetryDelay.ToString();
        await iotClient.UpdateReportedPropertiesAsync(reportedProperties).ConfigureAwait(false);
        Console.WriteLine("Reported Twin Properties:");
        Console.WriteLine($"{reportedProperties.ToJson()}");
    }
    ```

    `OnDesiredPropertyChanged` メソッドは、デバイス ツインの必要なプロパティを読み取るコードを含み、`_telemetryDelay` 変数を構成してから、報告されるプロパティをデバイス ツインに報告して、シミュレートされたデバイスの現在の状態がどの状態に構成されているかを Azure IoT Hub に伝えることに注意してください。

1. `RunAsync` メソッドで、`//TODO 2: を見つけます。デバイス ツイン プロパティのコメントを読み込みます`。

1. デバイス ツインの必要なプロパティを読み取り、デバイスの起動時に一致するようにデバイスを構成するには、`// TODO 2:` コメントを次のコードに置き換えます。

    ```csharp
    Console.WriteLine("Loading device twin Properties...");
    var twin = await iotClient.GetTwinAsync().ConfigureAwait(false);
    await OnDesiredPropertyChanged(twin.Properties.Desired, null);
    ```

    このコードは、シミュレートされたデバイスのデバイス ツインを取得する `DeviceTwin.GetTwinAsync` メソッドを呼び出します。次に、`Properties.Desired` プロパティ オブジェクトにアクセスして、デバイスの現在の必要な状態を取得し、それをシミュレートされたデバイスの `_telemetryDelay` 変数を構成する `OnDesiredPropertyChanged` メソッドに渡します。

    このコードでは、_OnDesiredPropertyChanged_ イベントを処理するために既に作成されている `OnDesiredPropertyChanged` メソッドを再利用しています。  これにより、デバイス ツインの目的の状態プロパティを読み取り、起動時にデバイスを 1 か所で構成するコードを保持できます。結果のコードは、より簡単で保守が容易になります。

1. Visual Studio Code のトップ メニューで、「**ファイル**」 をクリックしてから、「**保存**」 をクリックします。   

    次に、シミュレートされたデバイスは、Azure IoT Hub のデバイス ツイン プロパティを使用して、テレメトリ メッセージ間の遅延を設定します。

### 演習 4: シミュレートされたデバイスのテスト

この演習では、シミュレートされたデバイスを実行し、センサー テレメトリを Azure IoT Hub に送信することを確認します。また、Azure IoT Hub 内のシミュレートされたデバイスのデバイス ツインを更新することで、テレメトリが Azure IoT Hub に送信される遅延も更新します。

#### タスク 1: デバイスをビルドおよび実行する

1. Visual Studio Code でコード プロジェクトを開いていることを確認します。

1. トップ メニューの 「**表示」**」 をクリックし、「**ターミナル**」 をクリックします。

1. ターミナル ペインで、コマンド プロンプトに `Program.cs` ファイルのディレクトリ パスが表示されていることを確認します。

1. コマンド プロンプトで、シミュレートされたデバイス アプリケーションをビルドして実行するには、次のコマンドを入力します。

    ```cmd/sh
    dotnet run
    ```

    > **注意**: シミュレートされたデバイス アプリケーションを実行すると、まず、その状態に関する詳細がコンソール (ターミナル ペイン) に書き込まれます。

1. `Desired Twin Property Changed:`行の後の JSON 出力には、デバイスの `telemetryDelay` に必要な値が含まれていることに注意してください。

    ターミナル ペインを上にスクロールして、出力を確認できます。次のようになるはずです。

    ```text
    RegistrationID = DPSSimulatedDevice1
    ProvisioningClient RegisterAsync ...デバイス登録ステータス: 割り当て済み
    ProvisioningClient AssignedHub: AZ-220-HUB-CP1019.azure-devices.net; DeviceID: DPSSimulatedDevice1
    対称キー DeviceClient 認証の作成
    シミュレートされたデバイス。Ctrl-C を押して終了します。
    DeviceClient OpenAsync.
    SetDesiredPropertyUpdateCallbackAsync イベント ハンドラーに接続しています...
    デバイス ツインのプロパティを読み込んでいます...
    必要なツイン プロパティが変更されました:
    {"telemetryDelay":"2","$version":1}
    報告されるツイン プロパティ:
    {"telemetryDelay":2}
    デバイス テレメトリの読み取りと送信を開始します
    ```

1. シミュレートされたデバイス アプリケーションが Azure IoT Hub にテレメトリ イベントを送信し始めることに注意してください。

    テレメトリ イベントには、`temperature`、`humidity`、`pressure`、`latitude`、および`longitude`の値が含まれ、次のようになるはずです。

    ```text
    11/6/2019 6:38:55 PM > Sending message: {"temperature":25.59094770373355,"humidity":71.17629229611545,"pressure":1019.9274696347665,"latitude":39.82133964767944,"longitude":-98.18181981142438}
    11/6/2019 6:38:57 PM > Sending message: {"temperature":24.68789062681044,"humidity":71.52098010830628,"pressure":1022.6521258267584,"latitude":40.05846882452387,"longitude":-98.08765031156229}
    11/6/2019 6:38:59 PM > Sending message: {"temperature":28.087463226675737,"humidity":74.76071353757787,"pressure":1017.614206096327,"latitude":40.269273772972454,"longitude":-98.28354453319591}
    11/6/2019 6:39:01 PM > Sending message: {"temperature":23.575667940813894,"humidity":77.66409506912534,"pressure":1017.0118147748344,"latitude":40.21020096551372,"longitude":-98.48636739129239}
    ```

    テレメトリの読み取り値のタイムスタンプの違いに注目してください。テレメトリ メッセージ間の遅延は、ソース コードでの規定値 `1` 秒ではなく、デバイス ツインを介して構成されるように `2` 秒となる必要があります。

1. シミュレートされたデバイス アプリを実行したままにします。

    デバイス コードが次のアクティビティで期待どおりに動作していることを確認します。

#### タスク 2: Azure IoT Hub に送信されるテレメトリ ストリームを確認する

このタスクでは、Azure CLI を使用して、シミュレートされたデバイスから送信されたテレメトリが Azure IoT Hub によって受信されていることを確認します。

1. ブラウザーを使用して [Azure Cloud Shell](https://shell.azure.com/) を開き、このコースで使用している Azure サブスクリプションでログインします。

1. Azure Cloud Shell で、次のコマンドを入力します。

    ```cmd/sh
    az iot hub monitor-events --hub-name {IoTHubName} --device-id DPSSimulatedDevice1
    ```

    _必ず、**{IoTHubName}** プレースホルダーを Azure IoT Hub の名前に置き換えてください。_

1. IoT ハブが DPSSimulatedDevice1 デバイスからテレメトリ メッセージを受信していることに注意してください。

    次のタスクのために、シミュレートされたデバイス アプリケーションを実行したままにします。

#### タスク 3: ツインを使用してデバイスの構成を変更する

シミュレートされたデバイスを実行すると、Azure IoT Hub 内でデバイス ツインの必要な状態を編集することで、`telemetryDelay` 構成を更新できます。これは、Azure portal 内の Azure IoT Hub でデバイスを構成することで実現できます。

1. **Azure portal** を開き (まだ開いていない場合)、**Azure IoT Hub** サービスに移動します。

1. IoT ハブ」 ブレードの左側にある 「**エクスプローラ**」 セクションで、「**IoT デバイス**」 をクリックします。   

1. IoT デバイスの一覧で、「**DPSSimulatedDevice1**」 をクリックします。 

    > **重要**: このラボで使用しているデバイスを選択していることを確認します。

1. デバイス ブレードのブレードの上部にある 「**デバイス ツイン**」 をクリックします。

    「**デバイス ツイン**」 ブレードでは、デバイス ツインの完全な JSON が編集者に提供されます。これにより、Azure portal 内でデバイス ツインの状態を直接表示および/または編集できます。

1. `properties.desired` オブジェクトの JSON の場所を特定します。

    これには、デバイスの望ましい状態が含まれています。`telemetryDelay` プロパティは既に存在し、DPS の個別登録に基づいてデバイスがプロビジョニングされたときに構成されたとおりに `"2"`に設定されていることに注意してください。

1. 目的の `telemetryDelay` プロパティに割り当てられた値を更新するには、値を`"5"`に変更します。

    値には引用符 ("") が含まれます。

1. ブレードの上部にある 「**保存**」 をクリックします。

    `OnDesiredPropertyChanged` イベントは、シミュレートされたデバイスのコード内で自動的にトリガーされ、デバイスは、デバイス ツインの必要な状態への変更を反映するように、その構成を更新します。

1. シミュレートされたデバイス アプリケーションを実行するために使用している Visual Studio Code ウィンドウに切り替えます。

1. Visual Studio Code で、ターミナル ウィンドウの下部までスクロールします。

1. デバイスが、デバイス ツインプロパティの変更を認識することに注意してください。

    出力には、新しい必要な `telemetryDelay` プロパティ値の JSON と共に、`Desired Twin Property Changed`というメッセージが表示されます。デバイスは、デバイス ツインの必要な状態の新しい構成を選択すると、現在構成されているように、5 秒ごとにセンサー テレメトリの送信を開始するよう自動的に更新されます。

    ```text
    必要なツイン プロパティが変更されました:
    {"telemetryDelay":"5","$version":2}
    報告されるツイン プロパティ:
    {"telemetryDelay":5}
    11/6/2019 7:29:55 PM > メッセージ送信: {"temperature":33.01780830277959,"humidity":68.52464504936927,"pressure":1023.0929576073974,"latitude":39.97641877038439,"longitude":-98.49544472071804}
    11/6/2019 7:30:00 PM > メッセージ送信: {"temperature":33.95490410689027,"humidity":71.57070464062072,"pressure":1013.3468084112261,"latitude":40.01604868659767,"longitude":-98.51051877869526}
    11/6/2019 7:30:05 PM > メッセージ送信: {"temperature":22.055266337494956,"humidity":67.50505594886144,"pressure":1018.1765662249767,"latitude":40.22292566031555,"longitude":-98.4367936214764}
    ```

1. Azure Cloud Shell で Azure CLI コマンドを実行しているブラウザー ページに切り替えます。

    `az iot hub monitor-events` コマンドがまだ実行されていることを確認します。実行されていない場合は、コマンドを再度開始します。

1. Azure IoT Hub に送信されたテレメトリ イベントが、新しい間隔 5 秒で受信されていることに注意してください。

1. **Ctrl+C** を使用して `az`  コマンドとシミュレートされたデバイス  アプリケーションの両方を停止します。 

1. Azure portal で、「**デバイス ツイン**」 ブレードに移動します。

1. Azure portal の 「シミュレートされたデバイス」 ブレードで、「**デバイス ツイン**」 をクリックします。

1. 今回は、`properties.reported` オブジェクトの JSON を探します。

    これには、デバイスによって報告された状態が含まれます。`telemetryDelay` プロパティもここに存在し、`5` に設定されていることに注意してください。  また、値が最後に更新された時点と、特定のレポート値が最後に更新された時刻を示す `$metadata` 値もあります。

1. もう一度 **デバイス ツイン**ブレードを閉じます。

1. シミュレートされたデバイス ブレードを閉じ、IoT Hub ブレードを閉じます。

### 演習 5: デバイスの削除

この単元では、デバイス プロビジョニング サービス (DPS) と Azure IoT Hub の両方からデバイスを廃棄するために必要なタスクを実行します。Azure IoT ソリューションから IoT デバイスを完全に廃棄するには、これらの両方のサービスから削除する必要があります。トランスポート ボックスが最終目的地に到着すると、センサーをボックスから取り外し、「廃棄」する必要があります。デバイスの完全な廃棄は、IoT ソリューションにおける IoT デバイスのライフサイクルの重要なステップです。

#### タスク 1: DPS からデバイスを取り出します。

1. 必要に応じて、Azure アカウントの認証情報を使用して Azure portal にログインします。

    複数の Azure アカウントをお持ちの場合は、このコースで使用するサブスクリプションに関連付けられているアカウントでログインしていることを確認してください。

1. 前のタスクで作成した **AZ-220** ダッシュボードが読み込まれています。

    IoT ハブと DPS の両方のリソースが表示されます。

1. リソース グループ タイルで、デバイス プロビジョニング サービスに移動するには、 **「AZ-220-DPS-_{YOUR-ID}_」** をクリックします。 

1. デバイス プロビジョニング サービス ブレードの左側のメニューで、 **「登録の管理」** をクリックします。  

1. 「登録の管理」 ブレードで、個々のデバイス登録の一覧を表示するには、「**個別登録**」をクリックします。  

1. DPS のシミュレートされた 1 個々のデバイス登録を選択するには、名前の左側にあるチェックボックスを選択します。

    デバイス登録を開くのではなく、デバイスを選択するだけです。

1. ブレードの上部で、「**削除**」 をクリックします。

    > **注意**: DPS から個々の登録を削除すると、登録が恒久的に削除されます。一時的に登録を無効にするには、個々の登録の 「**登録の詳細**」 で 「**エントリを有効にする」** 設定を 「**無効にする**」 に設定します。

1. 「**登録の削除**」 プロンプトで 「**はい**」 をクリックします。

    これで、個別登録がデバイス プロビジョニング サービス (DPS) から削除されます。デバイスの廃棄を完了するには、シミュレートされたデバイスの **デバイス ID** も **Azure IoT Hub** サービスから削除する必要があります。 

#### タスク 2: IoT Hub からデバイスを削除する

1. Azure portal で、ダッシュボードにもう一度アクセスしてください。

1. リソース グループ タイルで、「**AZ-220-HUB-_{YOUR-ID}_**」 をクリックして Azure IoT Hub に移動します。 

1. IoT ハブ ブレードの左側にある**エクスプローラ** セクションで、「**IoT デバイス**」 をクリックします。

1. IoT デバイスのリスト内で、DPSSimulatedDevice1 デバイス ID の左側にあるチェックボックスをオンにします。

    > **重要**: このラボで使用したシミュレートされたデバイスを表すデバイスを選択していることを確認します。

1. ブレードの上部で、「**削除**」 をクリックします。

1. 「**選択したデバイスを削除しますか**」 のプロンプトで、「**はい**」 をクリックします。   

    > **注意**:  IoT ハブからデバイス ID を削除すると、デバイスの登録が完全に削除されます。デバイスが IoT ハブ に接続できないように一時的に無効にするには、 デバイスのプロパティ内で 「**IoT Hub への接続を有効にする**」 を 「**無効にする**」 に設定します。

これで、デバイス登録がデバイス プロビジョニング サービスから削除され、一致するデバイス ID が Azure IoT Hub から削除されたので、シミュレートされたデバイスがソリューションから完全に退避されました。
