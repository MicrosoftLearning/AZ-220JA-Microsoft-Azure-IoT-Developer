# 統合シナリオ

これは、編集を支援する完全なシナリオを含む、進行中のドキュメントです。

> **注意**: これは、シナリオ全体が個々のラボにロールされると削除されます。

## LAB_AK_01

### ラボ シナリオ

あなたは、Contoso という名前の主要なグルメ チーズ会社の Azure IoT 開発者です。Contoso は IoT のビジネス チャンスを評価し、達成できる大きなメリットがあると結論付けました。彼らは評価に基づいて Microsoft Azure IoT を選択しました。

まず、Azure ツールに精通する必要があります。

#### 演習 1: Azure portal とダッシュボードの詳細

Azure IoT サービスの使用を開始する前に、Azure 自体のしくみを理解しておくと便利です。

Azure は一般的に「クラウド」と呼ばれていますが、実際には、単一の Web サイトから Azure リソースにアクセスできるように設計された Web ポータルです。すべての Azure は Azure portal を通してアクセスできます

#### 演習 2: Azure ダッシュボードとリソース グループの作成

Azure portal では、ダッシュボードを使用して、リソースのカスタマイズされたビューを表示します。情報は、便利な方法でリソースを整理するために配置およびサイズを設定することができるタイルを使用して表示されます。さまざまなビューを提供し、さまざまな目的を果たすさまざまなダッシュボードを作成できます。

ダッシュボードに配置した各タイルには、1 つ以上のリソースが表示されます。個々のリソースのデータを公開するタイルに加えて、リソース グループと呼ばれるもののタイルを作成できます。

リソース グループは、プロジェクトまたはアプリケーションに関連するリソースを含む論理グループです。リソース グループには、ソリューションのすべてのリソース、またはグループとして管理するリソースのみを含めることができます。組織に最も合ったものに基づいてリソースグループにリソースを割り当てる方法を決定します。一般的に、同じライフサイクルを共有するリソースを同じリソース グループに追加すると、グループとして簡単にデプロイ、更新、および削除できます。

次のタスクでは、次の作業を行います。

* このコースで使用できるカスタム ダッシュボードを作成する
* リソース グループを作成し、ダッシュボードにリソース グループ タイルを追加する

## LAB_AK_02

### ラボ シナリオ

あなたは、グルメチーズを製造し販売する会社である Contoso で働く Azure IoT 開発者です。あなたは、会社が導入する予定の IoT ソリューションで使用する Azure および Azure IoT サービスのエクスペリエンスを担当します。Azure portal を理解し、プロジェクトのリソース グループを作成しました。次に、Azure IoT サービスの調査を開始する必要があります。

#### 演習 1: 一意の名前を持つリソースの名前付け

このコースでは、リソースを作成します。ラボ全体で一貫性を保つために、リソースを使い終わるたびにリソースを整理し、使用する必要がある名前を提供します。ただし、これらのリソースの多くは、Web で使用できるサービスを公開しているため、グローバルに一意の名前を持つ必要があります。これを実現するには、リソース名の末尾に追加される一意識別子を使用します。一意の ID を作成しましょう。

#### 演習 2: Azure portal を使用して IoT ハブを作成する

Azure IoT Hub は、IoT デバイスと Azure の間で信頼性とセキュリティで保護された双方向通信を実現するフルマネージド サービスです。Azure IoT Hub サービスでは、次の機能が提供されます。

* 数十億台の IoT デバイスと双方向通信を確立
* 一方向メッセージング、ファイル転送、要求/応答方式など、複数の device-to-cloud への通信オプションと cloud-to-device への通信オプション。
* 他の Azure サービスへの組み込みの宣言型メッセージ ルーティング。
* デバイス メタデータと同期状態情報のクエリ可能なストア。
* デバイスごとのセキュリティ キーまたは X.509 証明書を使用して、通信とアクセス コントロールを保護します。
* デバイス接続性とデバイス ID 管理イベントの広範囲のモニタリング。
* 最も一般的な言語とプラットフォームの SDK デバイス ライブラリ。

IoT ハブの作成には、いくつかの方法を使用できます。たとえば、Azure portal を使用して IoT ハブ リソースを作成できます。これは、このタスクで実行します。ただし、プログラムによって IoT ハブ (およびその他のリソース) を作成することもできます。このコースでは、Azure CLI や PowerShell など、Azure リソースの作成と管理に使用できる追加の方法について調査します。

#### 演習 3: IoT ハブ サービスを確認する

既に述べたとおり、IoT ハブはクラウドでホストされるマネージド サービスで、IoT アプリケーションとそれが管理するデバイス間の双方向通信用の中央メッセージ ハブとして機能します。

IoT ハブの機能は、製造で使用される産業機器の管理、ヘルスケアの貴重な資産のトラッキング、オフィス ビルの使用状況の監視など、スケーラブルですべての機能を備えた IoT ソリューションの構築に役立ちます。IoT Hub の監視は、デバイスの作成、デバイスの障害、デバイスの接続などのイベントを追跡することで、ソリューションの正常性を維持するのに役立ちます。

#### 演習 4: Azure portal を使用して デバイス プロビジョニング サービスを作成する

Azure IoT Hub Device Provisioning Service は、人間の介入を必要とせずに、適切な IoT ハブに対してゼロタッチの Just-In-Time プロビジョニングを可能にする IoT ハブのヘルパー サービスです。デバイス プロビジョニング サービスでは、次の機能が提供されます。

* 工場出荷時に IoT ハブ接続情報をハードコーディングすることなく、単一の IoT ソリューションにゼロタッチ プロビジョニングを行う (初期設定)
* 複数のハブ間でデバイスを負荷分散
* 販売取引データに基づいてデバイスをオーナーの IoT ソリューションに接続する (マルチテナント機能)
* ユースケースに応じた特定の IoTソリューションへのデバイスの接続 (ソリューション分離)
* 最短の待ち時間でデバイスを IoT ハブに接続する (geo シャーディング)
* デバイスの変更に基づく再プロビジョニング
* IoT ハブに接続するためにデバイスで使用されるキーのロール (X.509 証明書を使用して接続しない場合)

IoT Hub Device Provisioning Service のインスタンスを作成するために使用できる方法がいくつかあります。たとえば、このタスクで使用する、Azure portal を使用できます。ただし、Azure CLI または Azure Resource Manager テンプレートを使用して DPS インスタンスを作成することもできます。

#### 演習 5: デバイス プロビジョニング サービスの確認

IoT Hub Device Provisioning Service は、人間の介入を必要とせずに、適切な IoT ハブへのゼロタッチの Just-In-Time プロビジョニングを実現するヘルパー サービスです。これにより、安全かつスケーラブルな方法で何百万ものデバイスをプロビジョニングできます。

## LAB_AK_03

### ラボ シナリオ

Contoso の開発者の 1 人として、Azure IoT ソリューションの構築を開始する前に、開発環境をセットアップすることが重要なステップであることをご存じでしょう。Microsoft  には、IoT ソリューションの開発とサポートに使用できるツールが多数用意されており、チームがどのツールを使用するかについて決定する必要があることをご存じでしょう。チームが IoT ソリューションの開発に使用できる作業環境を、Azure クラウド側とローカルの作業環境の両方で準備します。

議論した後に、チームは開発環境について次の大まかな決定を下しました。

* オペレーティング システム:  Windows 10 は OS として使用されます。Windows はほとんどのチームで使用されているので、論理的な選択でした。Azure IoT サービスは他のオペレーティング システム (Mac OS や Linux など) をサポートしており、Microsoft では、これらの代替案のいずれかを選択したチームのメンバー向けにサポート ドキュメントが用意されています。
* 一般的なコーディング ツール:  Visual Studio Code と Azure CLI は、主要なコーディング ツールとして使用されます。これらのツールでは両方とも、Azure IoT SDK を活用する IoT の拡張機能がサポートされます。
* IoT Edge ツール: Docker Desktop コミュニティと Python は、カスタムの IoT Edge モジュールの開発をサポートするために使用されます。

これらの決定を支持して、次の環境を設定します。

* Windows 10 64 ビット: Pro、Enterprise、または Education (ビルド 15063 以降)。下記が含まれます。
  * 4 GB – 8 GB システム RAM (Docker の場合は高い方が良い)
  * Windows の Hyper-V およびコンテナの機能を有効にする必要があります。
  * BIOS レベルのハードウェア仮想化サポートは、BIOS 設定で有効にする必要があります。

  > **注意**: 仮想マシンに開発環境を設定する場合、VM 環境は入れ子になった仮想化 ([入れ子になった仮想化](https://docs.microsoft.com/ja-jp/virtualization/hyper-v-on-windows/user-guide/nested-virtualization)) をサポートする必要があります。

* Azure CLI (現在/最新)
* .NET Core 3.0.100 (or later) SDK
* VS Code (最新)
* Python 3.7 (3.8 ではない)
* Linux コンテナーに設定された Docker Desktop Community 2.1.0.5 以降
* Power BI Desktop (データ視覚化用)
* VS Code と Azure CLI の IoT 拡張機能

> **注意**: 仮想マシンは、このコースに向けて作成されました。ここでは、上記で指定されているツールの大部分を提供しています。以下の手順では、準備済み VM の使用、または Windows PC をローカルで使用する環境の設定をサポートしています。

#### 演習 1: 開発者ツールと製品のインストール

> **注意**: この演習に関連付けられているツールと製品は、このコース用に作成された仮想マシンに事前インストールされています。続行する前に、ホストされたラボの VM 環境を使用してラボを完了するのか、またはお使いの PC にローカルで開発環境を設定するのかについて、コース担当講師に確認してください。

#### 演習 2: 開発ツール拡張機能のインストール

Visual Studio Code と Azure CLI ツールはどちらも、開発者がソリューションをより効率的に作成するのに役立つ拡張機能をサポートします。Microsoft によって開発された IoT の拡張機能は、IoT SDK を活用し、開発期間を短縮します。

#### 演習 3: コースの課題ファイルと代替ツールの設定

このコースの多くのラボでは、課題活動の開始点として使用できるコード プロジェクトなど、あらかじめ構築されたリソースを使用しています。GitHub プロジェクトを使用して、これらのラボ リソースへのアクセスを提供します。コース ラボ (GitHub プロジェクトに含まれるリソース) を直接サポートするリソースに加えて、実際のコース以外の学習機会をサポートするために使用できるツールもあります。以下の手順は、これらのリソースの種類の両方の構成を示しています。

## LAB_AK_04

### ラボ シナリオ

Contoso は、高品質のチーズを生産することで知られています。同社の人気と販売の両方が急成長しているため、彼らは顧客の期待に応える高品質なチーズを確実に維持するための方策を講じたいと考えています。

昔は、各勤務シフト中に工場の現場担当者が温度と湿度のデータを収集していました。同社は、新しい施設が稼働し始めるにつれて、工場の拡張により監視の強化が必要になることと、データを収集する手動プロセスでは調整できなくなることを懸念しています。

Contoso は温度と湿度を監視するために、IoT デバイスを使用する自動化システムを立ち上げることにしました。テレメトリ データの通信速度は調整可能で、チーズのバッチが環境に敏感なプロセスを進める際に製造プロセスが確実に制御されるようにします。

この資産監視ソリューションをフルスケールの実装前に評価するには、IoT デバイス (温度センサーと湿度センサーを含む) を IoT Hub に接続します。

#### 演習 1: ラボの前提条件を確認する

このラボでは、次の Azure リソースが使用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |

#### 演習 2: Azure CLI を使用して Azure IoT Hub デバイス ID を作成する

`iot` Azure CLI モジュールには、`az iot hub device-identity` コマンド グループの下にある Azure IoT Hub 内の IoT デバイスを管理するためのいくつかのコマンドが含まれています。これらのコマンドは、スクリプト内の IoT デバイスを管理したり、コマンドライン/ターミナルから直接 IoT デバイスを管理するために使用できます。

#### 演習 3: シミュレートされたデバイス (C#) の構成とテスト

この演習では、前の演習で作成したデバイス ID と共有アクセス キーを使用して Azure IoT Hub に接続するために、C# で記述されているシミュレートされたデバイスを構成します。次に、デバイスをテストし、IoT Hub がデバイスから正常にテレメトリを受信していることを確認します。

## LAB_AK_05

### ラボ シナリオ

Contoso の経営陣は、IoT デバイスを使用して現在のシステムで必要な手動のデータ入力作業を削減し、出荷プロセス時により高度な監視機能を提供する、自社の資産の監視および追跡ソリューションの更新を強く要求しています。このソリューションは、IoT デバイスのプロビジョニングとプロビジョニング解除を行う機能に依存しています。プロビジョニング要件を管理するための最良の選択肢は DSP のようです。

提案されたシステムは、輸送中の輸送コンテナーの場所、温度、圧力をトラッキングするために、統合されたセンサーを備えた IoT デバイスを使用します。デバイスは、Contoso がチーズの輸送に使用する既存の出荷コンテナー内に配置され、車両が提供する WiFi を使用して Azure IoT Hub に接続します。新しいシステムは、製品環境の継続的な監視を提供し、問題が検出されたときにさまざまな通知シナリオを可能にします。

Contoso のチーズ パッケージング施設では、空のコンテナーがシステムに入ると、新しい IoT デバイスが装備され、パッケージ化されたチーズ製品がロードされます。IoT デバイスは、デバイス プロビジョニング サービスを使用して IoT ハブに自動プロビジョニングする必要があります。コンテナーが宛先に到着すると、IoT デバイスが取得され、DPS を通じて "使用停止" されます。デバイスは、今後の出荷に再利用されます。

DPS を使用してデバイス プロビジョニングとプロビジョニング解除プロセスを検証する作業を担当します。プロセスの初期段階では、個別登録アプローチを使用します。

#### 演習 1: ラボの前提条件を確認する

このラボでは、次の Azure リソースが使用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| デバイス プロビジョニング サービス | AZ-220-DPS-_{YOUR-ID}_ |

#### 演習 2: DPS での新しい個別登録 (対称キー) の作成

この演習では、_対称キー構成証明_を使用して、デバイス プロビジョニング サービス (DPS) 内のデバイスに対して新しい個別登録を作成します。

#### 演習 3: シミュレートされたデバイスの構成

この演習では、前の単元で作成した個々の登録を使用して Azure IoT に接続するように、C# で記述されたシミュレートされたデバイスを構成します。また、Azure IoT Hub 内のデバイス ツインに基づくデバイス構成を読み取って更新するコードをシミュレートされたデバイスに追加します。

この演習で作成するシミュレートされたデバイスは、出荷コンテナーやボックス内に配置される IoT デバイスを表し、Contoso 製品の転送中の監視に使用されます。Azure IoT Hub に送信されるデバイスからのセンサー テレメトリには、コンテナーの温度、湿度、圧力、緯度/経度座標が含まれています。デバイスは、全体的な資産追跡ソリューションの一部です。

これは、シミュレートされたデバイスが Azure に接続された以前のラボとは異なります。そのラボでは認証に共有アクセス キーを使用してデバイスのプロビジョニングを必要とせず、プロビジョニング管理の利点 (デバイス ツインなど) も提供しないためです。また、共有キーのかなり大希望な配布と管理が必要です。  このラボでは、デバイス プロビジョニング サービスを使用して一意のデバイスをプロビジョニングします。

#### 演習 4: シミュレートされたデバイスのテスト

この演習では、シミュレートされたデバイスを実行し、センサー テレメトリを Azure IoT Hub に送信することを確認します。また、Azure IoT Hub 内のシミュレートされたデバイスのデバイス ツインを更新することで、テレメトリが Azure IoT Hub に送信される遅延も更新します。

#### 演習 5: デバイスの削除

この単元では、デバイス プロビジョニング サービス (DPS) と Azure IoT Hub の両方からデバイスを廃棄するために必要なタスクを実行します。Azure IoT ソリューションから IoT デバイスを完全に廃棄するには、これらの両方のサービスから削除する必要があります。トランスポート ボックスが最終目的地に到着すると、センサーをボックスから取り外し、「廃棄」する必要があります。デバイスの完全な廃棄は、IoT ソリューションにおける IoT デバイスのライフサイクルの重要なステップです。

## LAB_AK_06

### ラボ シナリオ

Contoso の資産の監視および追跡ソリューションに対する現在までの作業により、個々の登録を使用してデバイスのプロビジョニングとプロビジョニング解除のプロセスを検証することが可能になりました。管理チームから、より大規模なプロセスの展開を開始するよう指示を受けました。

プロジェクトを進めるには、デバイス プロビジョニング サービスを使用して、より多くのデバイスを自動的に登録し、X.509 証明書認証を使用して、安全に登録できることを実証する必要があります。

#### 演習 1: ラボの前提条件を確認する

このラボでは、次の Azure リソースが使用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| デバイス プロビジョニング サービス | AZ-220-DPS-_{YOUR-ID}_ |

#### 演習 2: OpenSSL を使用した X.509 CA 証明書の生成と構成

この演習では、 Azure Cloud Shell 内で OpenSSL を使用して X.509 CA 証明書を生成します。この証明書は、デバイス プロビジョニング サービス (DPS) 内のグループ登録を構成するために使用されます。

#### 演習 3: DPS でのグループ登録 (X.509 証明書) の作成

この演習では、_証明書の構成証明_を使用して、デバイス プロビジョニング サービス (DPS) 内のデバイスに対して新しい個別登録 を作成します。

#### 演習 4: X.509 証明書を使用してシミュレートされたデバイスを構成する

この演習では、X.509 証明書を使用してデバイス プロビジョニング サービス (DPS) を介して Azure IoT Hub に接続するように、C# で記述されたシミュレートされたデバイスを構成します。この演習では、 `/LabFiles` ディレクトリ内で、**シミュレートされたデバイス** ソース コード内のワークフローや、DPS で認証し、IoT Hub にメッセージを送信する方法を紹介します。

#### 演習 5: デバイス ツインの必要なプロパティの変更を処理します。

この演習には、シミュレートされたデバイス ソース コードを変更して、Azure IoT Hub からデバイスに送信されたデバイス ツインの必要なプロパティの変更に基づいてデバイス構成を更新するイベント ハンドラーが含まれます。

デバイス ツインは、メタデータ、構成、条件などのデバイス状態情報を格納する JSON ドキュメントです。Azure IoT Hub では、IoT Hub に接続するデバイスごとにデバイス ツインが維持されます。

デバイス プロビジョニング サービス (DPS) には、グループ登録を使用して登録されたデバイスの初期デバイス ツインの必要なプロパティが含まれています。デバイスが登録されると、DPS のこの初期デバイス ツイン構成を使用して IoT ハブ内にデバイスが作成されます。登録後、Azure IoT Hub は、IoT Hub デバイス レジストリ内の各デバイスのデバイス ツイン (およびそのプロパティ) を維持します。

デバイス ツインの必要なプロパティが Azure IoT Hub 内のデバイスに対して更新されると、必要な変更が C# SDK を使用した `DesiredPropertyUpdateCallback` イベントを使用して IoT デバイスに送信されます。デバイス コード内でこのイベントを処理すると、Azure IoT Hub 内のデバイスのデバイス ツイン状態を簡単に管理することにより、デバイスの構成とプロパティを必要に応じて更新できます。

この一連の手順は、概念とプロセスが同じであるため、シミュレートされたデバイスを操作するための以前のラボの手順と非常によく似ています。  プロビジョニング プロセスの認証に使用される方法は、デバイスがプロビジョニングされた後は、デバイス ツイン プロパティの変更処理を変更しません。

#### 演習 6: シミュレートされたデバイスのテスト

この演習では、シミュレートされたデバイスを実行します。デバイスが初めて起動されると、デバイス プロビジョニング サービス (DPS) に接続され、構成されたグループ登録を使用して自動的に登録されます。DPS グループ登録に登録すると、デバイスは Azure IoT Hub デバイス レジストリ内に自動的に登録されます。登録が完了すると、デバイスは構成済みの X.509 証明書認証を使用して Azure IoT Hub との通信を安全に開始します。

#### 演習 7: グループ登録の廃止

この演習では、登録グループとそのデバイスをデバイス プロビジョニング サービスと Azure IoT Hub の両方から取り外します。

## LAB_AK_07

### ラボ シナリオ

Contoso Management は、自動デバイス登録の実装に感銘を受けたので、これでビジネス価値を提供できるシナリオを検討する準備が整いました。

チーズ製造ビジネスの重要な部分は、チーズを包装して顧客に出荷することです。コスト効率を最大化するために、Contoso はオンプレミスのパッケージング施設を運営しています。ワークフローは簡単です - パッケージは出荷のために組み立てられ、パッケージを取り出し、郵便箱にそれらを落とすコンベア ベルトに置かれます。成功のメトリックは、コンベアベルトを離れるパッケージの数です。

コンベヤベルトはプロセスの重要なリンクであり、振動を監視しています。コンベヤベルトは3つの速度を有します: 停止、低速、高速低速で配送される荷物の数は、より速い速度の荷物よりも少なくなりますが、振動も低速では少なくなります。振動が過剰になると、コンベアベルトを止めて検査する必要があります。

振動にはさまざまな種類があります。強制振動は外力による振動です。壊れたホイールの例のような力、またはコンベヤベルトに不適切に配置された重量のあるパッケージ。また、振動が増加しており、設計の制限を超えた場合に発生する可能性があります。

振動は通常、加速度(メートル/秒平方メートル、m/s²)として測定されます。

ここでの究極の目標は予防保全です。任意の損傷が発生する前に、何かが間違っていることを検出します。 

> **注意**: **予防保全**(予防保護とも呼ばれる)は、機器が正常に動作している間に実行されるメンテナンス活動をスケジュールする、設備メンテナンスプログラムです。このアプローチの目的は、多くの場合コストのかかる混乱が発生する、予期しない故障を回避することです。

異常な振動レベルを検出することは必ずしも容易ではありません。このため、Azure IoT Hub でデータ異常を検出する必要があります。振動検出センサーをコンベア ベルトに取り付け、IoT Hub に継続的なテレメトリを送信する予定です。IoT Hub では、Azure Stream Analytics と組み込みの機械学習 (ML) モデルを使用して、振動異常の事前警告を提供します。また、必要に応じてすべてのテレメトリ データをアーカイブする予定です。

シミュレートされた製品利用統計情報を最初に使用して、計画されたシステムのプロトタイプを構築することにしました。

#### 演習 1: ラボの前提条件を確認する

このラボでは、次のリソースが利用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| デバイス ID | VibrationSensorId |

#### 演習 2: 振動テレメトリのコードを記述する

コンベヤー ベルトを監視するキーは、振動テレメトリの出力です。振動は通常加速度(m/s²)として測定されますが、時には1 g = 9.81 m/s² の g力で測定されることもあります。振動には 3 つのタイプがあります。

* 構造が振動する傾向がある周波数にすぎない、自然振動。
* 構造に影響を与えたときに発生するが、その後干渉なしに振動する、自由振動。
* 構造が何らかのストレスを受けているときに発生する強制振動。

強制振動は、私たちのコンベア ベルトにとって危険なものです。低レベルで始めたとしても、構造に途中で障害が発生するようにこの振動を構築できます。コンベヤ ベルトの操作で自由振動が発生するケースは少なくなります。ご存知のとおり、ほとんどの機械は自然振動を持っています。

構築するコード サンプルは、速度の範囲 (停止、低速、高速) で実行されるコンベア ベルトをシミュレートします。ベルトの回転が速ければ速いほど、より多くの荷物が配達されますが、振動の影響は大きくなります。ランダム化した正弦波に基づいて、自然振動を追加します。異常検出システムは、この正弦波のスパイクまたはディップを異常として誤って識別する可能性があります。次に、2つの形態の強制振動を追加します。1つ目は、振動の周期的増加の影響をします (下の画像を参照) 。そして2つ目は、増加する振動。正弦波が追加され、小さなものから始まり成長します。

私たちのコンベア ベルトには、センサーデバイス (シミュレートされた IoTデバイス) が1つしかないと仮定しています。振動データの通信に加えて、センサーも他のデータ (荷物の配送、周囲温度、および同様のメトリック) をポンプで送り出します。このラボでは、追加の値がストレージ アーカイブに送信されます。

このラボでのほぼすべてのコーディングは、この演習で完了します。C# でシミュレーター コードをビルドするのには、 Visual Studio Code を使用します。

この演習では、次の操作を行います。

* コンベア ベルトシミュレータを構築する
* 前ユニットで作成した IoT Hub にテレメトリ メッセージを送信する

このラボの後半では、少量の SQL コーディングを完了します。

#### 演習 3: Azure BLOB ストレージにメッセージ ルートを作成する

当社の振動監視システムのアーキテクチャでは、データをストレージと分析の2つの目的地に送信する必要があります。Azure IoT は、*メッセージ ルーティング*を通じて、適切なサービスにデータを移動させる優れた方法を提供します。 

シナリオでは、2 つのルートを作成する必要があります。

* 最初のルートは、データをアーカイブするためのストレージになる
* 2 番目のルートは、異常検出のためにイベント ハブになる

メッセージ ルートは一度に 1 つずつ構築およびテストするのが最善であるため、この演習ではストレージ ルートに焦点を当てます。このルートを「ログ」ルートと呼びます。これには、Azure リソースの作成のいくつかのレベルを掘り下げることが含まれます。このルートを構築するために必要なすべての機能は、Azure portal で使用できます。

ストレージ ルートをシンプルに保ち、Azure BLOB Storage を使用します (ただし、Data Lake Storage も利用できます)。メッセージ ルーティングの重要な機能は、受信データのフィルター処理です。SQL で書かれたフィルターは、特定の条件が満たされた場合にのみ、ルートを下に出力します。

データをフィルターする最も簡単な方法の 1 つは、メッセージ プロパティで、そのため、次の2行をコードに追加しました。

```csharp
...
テレメトリメッセージ.プロパティ.追加(「センサーID」、"VSTel")。
...
ログインメッセージ。プロパティ。追加(「センサーID」"VSLog");
```

メッセージルートに組み込まれた SQL クエリは、`sensorID` 値をテストできます。

この演習では、ログ記録ルートを作成してテストします。

#### 演習 4: ログ ルート Azure Stream Analytics ジョブ

ログ記録ルートが期待どおりに動作していることを確認するために、ログ 記録メッセージを Blob Storage にルーティングする Stream Analytics ジョブを作成し、Azure Portal の Storage Explorer を使用して検証できます。

これにより、ルートに次の設定が含まれていることを確認できます。

* **名前** -  vibrationLoggingRoute
* **データ ソース** -  DeviceMessages
* **ルーティング クエリ** -  sensorID = "VSLog"
* **エンドポイント** -  vibrationLogEndpoint
* **有効化** -  true

> **注意**: ルーティングデータをストレージに送信するのに、Azure Stream Analytics を介して再度送信するのは変だと思われるかもしれません。  作成シナリオでは、両方のパスを長期的には使用しません。  代わりに、ここで作成している 2 番目のパスは存在していません。  ここでは、ラボ環境で簡単に検証できる方法で Azure Stream Analytics を実演するために簡易的な手法を使用しています。

## LAB_AK_08

### ラボ シナリオ

パッケージを受け取って配送箱に入れ込むコンベア ベルト システムの振動データやその他のテレメトリ出力を生成するデバイス シミュレーターを開発しました。Azure BLOB ストレージにデータを送信するログ ルートを構築して、テストしました。

2 番目のルートは、Stream Analytics に対して入力が便利であるため、イベント ハブへのルートになります。Stream Analytics は、シナリオ上で検知する過剰な振動など、異常検出を処理する便利な方法です。

このルートは IoT ハブ上に作成され、Azure Stream Analytics ジョブへの入力として追加されます。

2 つの入力と 2 つの出力、およびより複雑なクエリを処理するようにジョブを更新する必要があります。

2 番目のルートを作成するプロセスは、エンドポイント作成時に分岐しますが、最初のルートと同様のプロセスに従います。イベント ハブは、テレメトリ ルートのエンドポイントとして選択されます。

この演習では、Event Hubs *名前空間*を作成します。次に、Event Hub の設定を完了するために名前空間の *インスタンス*を作成する必要があります。このインスタンスを新しいメッセージ ルートの宛先として使用できます。

ルートが作成されたら、クエリの更新に進みます。

#### 組み込みの機械学習モデルへの呼び出し

呼び出しの対象となる組み込み機械学習 (ML) 関数は `AnomalyDetection_SpikeAndDip` です。

`AnomalyDetection_SpikeAndDip` 関数は、データのスライディング ウィンドウを取り、異常を調べます。スライディング ウィンドウは、たとえば、テレメトリ データの最新の 2 分間である可能性があります。このスライディング ウィンドウは、リアルタイムに近いテレメトリの流れで対応します。スライディング ウィンドウのサイズが大きくなると、一般に異常検出の精度も高くなります。待ち時間も同様です。

データの流れが続くにつれて、アルゴリズムは通常の値の範囲を確立し、その標準と新しい値を比較します。結果は各値のスコアであり、指定された値が異常であるという信頼度を決めるパーセンテージです。低いは信頼度は無視されますが、信頼度の値が許容される割合が問題です。クエリでは、この転換点を 95% に設定します。

データにギャップがある場合 (コンベア ベルトはしばらくの間、停止します) のように、常に複雑な問題があります。アルゴリズムは、値を補完することによってデータのボイドを処理します。

> **注意**: 統計では、補完は欠損データを代入値に置き換えるプロセスになります。補完の詳細については、[ここ](https://en.wikipedia.org/wiki/Imputation_%28statistics%29)を参照してください。

利用統計情報の急上昇と急下降は一時的な異常です。ただし、振動の正弦波を扱うため、異常警報を引き起こす高い値または低い値の後に短い期間の「正常」値が続くと予想できます。オペレーターは、短時間に発生する異常のクラスターを探しています。このようなクラスターは、何かが誤っていることを示唆しています。

この他にも、トレンドを検出するモデルなど、組み込み ML モデルがあります。このモジュールの一部としてこれらのモデルは含まれていませんが、受講生はさらに深く調査するといいでしょう。

#### Power BI を使用したデータを視覚化する

数値データ、特に大量のデータを可視化することは、それ自体が課題です。何かが間違っていると推測する異常のシーケンスを人間のオペレータに警告する方法とは?

このモジュールに使用するソリューションは、Power BI が取得できるリアルタイム形式のデータを送信するために、Azure Stream Analytics の機能と共に、Power BI の一部の組み込み機能を使用することです。

Power BI のダッシュボード機能を使用して、多数のタイルを作成します。1 つのタイルには、実際の振動測定が含まれます。もう 1 つのタイルはゲージで、値が異常であることを 0.0 から 1.0 の信頼度で示します。3 番目のタイルでは、95% の信頼度に達したかどうかを示します。最後に、4 番目のタイルは、過去 1 時間で検出された異常の数を示します。X軸として時間を含めることによって、このタイルは、複数の異常が水平に一緒にクラスタリングされるため、短時間で連続して検出されたかどうかを明確にします。

4 番目のタイルを使用すると、テレメトリ コンソール ウィンドウ内の赤いテキストと異常を比較できます。振動が強制的に実行された場合、または増加した場合、またはその両方が発生したときに異常のクラスターが検出されていますか?

イベント ハブを作成し、2 番目のルートを作成して SQL クエリを更新し、Power BI ダッシュボードを作成して、すべてを実行してみましょう。

#### 演習 1: PowerBI にサインアップする

Power BI は個人データ分析および視覚化ツールになり、グループ プロジェクト、部門、または企業全体の背後にある分析と意思決定エンジンとしても機能します。後ほどこのラボで、PowerBI を使用してダッシュボードを構築し、データを視覚化します。この演習では、個人として Power BI にサインアップする方法を説明します。

>**注:** PowerBI サブスクリプションが既にある場合は、次の手順にスキップできます。

#### 演習 2: ラボの前提条件を確認する

ダッシュボードでデータを視覚化するには、リアルタイムのテレメトリが必要です。この演習では、前のラボの デバイス シミュレーター アプリが実行されていることを確認します。

#### 演習 3: Azure Event Hub ルートと異常クエリの追加

IoT Hub にテレメトリ データをストリーミングしたので、Azure Event Hub 名前空間と Azure Event Hub インスタンスをソリューションに追加します。Azure Event Hubs はストリーミング データの処理に最適で、ライブ ダッシュボード シナリオをサポートします。これは振動データを Power BI へ受け渡すのにお勧めです。

#### 演習 4: リアルタイムのメッセージ ルートを作成する

イベント ハブの名前空間とイベント ハブができたので、IoT ハブからイベント ハブにテレメトリ データを渡す必要があります。

#### 演習 5: テレメトリのルートを追加する

この新しい IoT ハブ ルートが整い、テレメトリ データがイベント ハブにストリーミングされた場合は、Stream Analytics ジョブを更新する必要があります。このジョブは、イベント ハブからのデータを使用し、**AnomalyDetection_SpikeAndDip** ML モデルを使用して分析し、結果を Power BI に出力する必要があります。

#### 演習 6: Power BI  ダッシュボードを作成する

シナリオの最後の部分は、実際のデータの視覚化です。ML モデルを介して振動製品利用統計情報を処理し、Power BI に結果を出力できるようジョブを更新しました。Power BI 内で、結果を視覚化し、オペレーターに意思決定サポートを提供するため、多数のタイルを含むダッシュボードを作成する必要があります。

## LAB_AK_09

### ラボ シナリオ

Contoso は、さまざまなチーズ洞窟の温度を監視できるように、接続された新しいサーモスタットをインストールしています。新しいサーモスタットが作成されたときに施設管理者に通知するアラートを作成します。

アラートを作成するには、IoT Hub で新しいサーモスタットが作成されたときに、デバイスで作成されたイベント タイプを Event Grid にプッシュします。Logic Apps インスタンスがこのイベント (Event Grid) に反応し、新しく作成されたデバイス、デバイス ID、および接続状態を警告する電子メールが設備管理者デバイスに送信されます。

#### 演習 1: ラボの前提条件を確認する

このラボでは、次のリソースが利用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |

リソースが利用できない場合は、ラボを開始する前に **lab-setup.azcli** スクリプトを実行してください。

#### 演習 2: メールを送信する HTTP Web Hook ロジック アプリを作成する

Azure Logic Apps は、企業や組織間でアプリ、データ、システム、サービスを統合する必要がある場合に、タスク、ビジネス プロセス、ワークフローをスケジュール、自動化および調整するのに役立つクラウド サービスです。

この演習では、HTTP Web Hook を介してトリガーされる新しい Azure ロジック アプリを作成し、Outlook.com のメール アドレスを使用してメールを送信します。

#### 演習 3: Azure IoT Hub イベント サブスクリプションを構成する

Azure IoT Hub は Azure Event Grid と統合されるため、イベント通知を他のサービスに送信し、ダウンストリーム プロセスをトリガーできます。Business Applications を構成して IoT ハブ イベントをリッスンし、信頼性が高くスケーラブルで安全な方法で重要なイベントに対応できるようにします。たとえば、データベースを更新し、作業チケットを作成し、新しい IoT デバイスが IoT ハブに登録されるたびにメール通知を送信するアプリケーションをビルドします。

この演習では、Azure IoT Hub 内にイベント サブスクリプションを作成して、アラート メールを送信するロジック アプリをトリガーする Event Grid 統合を設定します。

## LAB_AK_10

### ラボ シナリオ

Contoso の資産の状態を追跡すると、特定の資産における温度の急上昇が明らかになったため、根本的な原因を究明したいと考えています。私たちは事象を理解したいと考え、輸送トラックと飛行機から送られる IoT デバイスのセンサーデータを関連付けます。1 台のトラックで温度が上昇し、温度センサーと湿度センサーを持つ IoT デバイスを搭載した輸送ボックスの 1 つで熱スパイクが発生しました。チームは、ほぼリアルタイムでデータを解析することが可能で、製品が良好な状態に保たれるよう出荷プロセスの改善に役立つ根本原因分析をする必要があります。

Time Series Insights をソリューションに追加して、トラックと飛行機、および輸送ボックスに取り付けられた IoT デバイスで生成される大量の時系列データを迅速に格納、可視化、照会をし、時間の経過に伴う変化を視覚化します。

#### 演習 1: ラボの前提条件を確認する

このラボでは、次のリソースが利用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | `AZ-220-RG` |
| IoT Hub | `AZ-220-HUB-{YOUR-ID}` |
| デバイス ID | `トラックデバイス` |
| デバイス ID | `AirplaneDevice` |
| デバイス ID | `ContainerDevice` |

#### 演習 2: Time Series Insights の設定

Azure Time Series Insights (TSI) は、モノのインターネット (IoT) ソリューションの大規模に収集、処理、保存、分析、クエリするために使用されるエンドツーエンドのサービスとしてのプラットフォーム (PaaS) オファリングです。TSI は、時系列に対して高度にコンテキスト化および最適化されたデータのアドホック データ探索と運用分析のために設計されています。

この演習では、Azure IoT Hub で Time Series Insights (TSI) の統合を設定します。

#### 演習 3: シミュレートされた IoT デバイスを実行する

この演習では、シミュレートされたデバイスを実行して、テレメトリ イベントを Azure IoT Hub に送信します。

#### 演習 4: Time Series Insights Explorer の表示

この演習では、Time Series Insights (TSI) Explorer を使用して時系列データを操作する方法について説明します。

## LAB_AK_11

### ラボ シナリオ

Contoso 社は世界各地にチーズ生産工場を持っています。工場には生産ラインが装備されており、チーズ製造機が複数あります。現時点では、IoT デバイスに接続された各コンピューターからセンサー データを Azure に転送し、クラウドですべてのデータを処理しています。大量のデータが収集され、一部のコンピューターでは緊急の応答が必要なため、Contoso は重要なデータのみをクラウドに送信できるように、エッジにデータ処理のインテリジェンスを持たせるゲートウェイ デバイスを追加したいと考えています。さらに、ローカル ネットワークが貧弱な場合でも、データを処理し、迅速に対応できます。

1 台のマシンの温度を監視できる新しい IoT Edge デバイスを設定し、Stream Analytics モジュールを展開して平均温度を計算し、デバイスにアラートを送信して迅速に動作するようにします。

#### 演習 1: ラボの前提条件を確認する

[tbd]

#### 演習 2: Azure IoT Edge 対応 Linux VM をデプロイする

この演習では、 Azure Marketplace の Azure IoT Edge ランタイム サポートを使用して Ubuntu サーバー VM をデプロイします。

#### 演習 3: Azure CLI を使用して IoT ハブで IoT Edge デバイス ID を作成する

この演習では、Azure CLI を使用して、Azure IoT Hub 内に新しい IoT Edge デバイス ID を作成します。

#### 演習 4: IoT Edge デバイスを IoT ハブに接続する

この演習では、IoT Edge デバイスを Azure IoT Hub に接続します。

#### 演習 5: Edge デバイスに Edge モジュールを追加する

この演習では、シミュレートされた温度センサーをカスタム IoT Edge モジュールとして追加し、IoT Edge デバイスで実行するようにデプロイします。

#### 演習 6: IoT Edge モジュールとして Azure Stream Analytics をデプロイする

これで、tempSensor モジュールが IoT Edge デバイスにデプロイされ、実行されるようになったので、IoT Edge デバイスでメッセージを処理できる Stream Analytics モジュールを追加してから、IoT Hub に送信できます。

## LAB_AK_12

### ラボ シナリオ

このラボは理論に基づいた形で、IoT Edge デバイスをゲートウェイとして使用する方法について説明します。

IoT Edge デバイスをゲートウェイとして使用するパターンには、透過、プロトコル変換、および ID 変換の 3 つのパターンがあります。

**透過** – 理論的に IoT ハブに接続できるデバイスは、代わりにゲートウェイ デバイスに接続できます。ダウンストリーム デバイスは、独自の IoT ハブ ID があり、MQTT、AMQP、または HTTP プロトコルのいずれかを使用しています。ゲートウェイは、デバイスと IoT ハブの間の通信を単純に受け渡します。デバイスは、ゲートウェイ経由でクラウドと通信していることを認識しません。また、IoT ハブでデバイスと対話するユーザーは、中間ゲートウェイ デバイスを認識しません。したがって、ゲートウェイは透過的です。「IoT Edge デバイスを透過ゲートウェイとして使用して透過ゲートウェイを作成する」を参照してください。

**プロトコルの変換**- 非透過なゲートウェイ パターンとしても知られる、MQTT、AMQP、または HTTP をサポートしないデバイスは、ゲートウェイ デバイスを代理として使用して IoT Hub にデータを送信できます。ゲートウェイは、ダウンストリーム デバイスによって使用されるプロトコルを認識する、IoT Hub の ID を持つ唯一のデバイスです。すべての情報は、1 つのデバイスまたはゲートウェイから来ているように見えます。クラウド アプリケーションでデバイスごとにデータを分析する場合、ダウンストリーム デバイスはそのメッセージに追加の識別情報を埋め込む必要があります。また、ツインやメソッドなどの IoT Hub プリミティブは、ゲートウェイ デバイスに対してのみ使用できるものであり、ダウンストリーム デバイスに対しては使用できません。

**ID の変換** -  IoT Hub に接続できないデバイスは、その代わりとして、ゲートウェイ デバイスに接続できます。ゲートウェイは、ダウンストリーム デバイスの代理で IoT Hub の ID を提供し、プロトコルを変換します。ゲートウェイは、ダウンストリーム デバイスが使用するプロトコルを理解するほど賢く、これらのデバイスに ID を提供して IoT Hub プリミティブを変換します。ダウンストリーム デバイスは、ツインとメソッドを持つファースト クラスのデバイスとして IoT Hub に表示されます。ユーザーは IoT Hub のデバイスとやり取りできますが、中間ゲートウェイ デバイスは認識しません。

#### 演習 1: ラボの前提条件を確認する

[tbd]

#### 演習 2: Azure IoT Edge 対応 Linux VM をデプロイする

この演習では、 Azure Marketplace の Azure IoT Edge ランタイム サポートを使用して Ubuntu サーバー VM をデプロイします。

#### 演習 3: IoT Edge デバイス CA 証明書を生成および構成する

この演習では、Linux を使用してテスト証明書を生成します。`Azure/IoTEdge` GitHub プロジェクトに含まれるヘルパー スクリプトを使用して、`AZ-220-VM-EDGEGW-{YOUR-ID}` 仮想マシンでこれを行います。

#### 演習 4: Azure portal を使用して IoT Hub に IoT Edge デバイス ID を作成する

この演習では、IoT Edge 透過ゲートウェイ用の Azure IoT Hub に新しい IoT Edge デバイス ID を作成します。

#### 演習 5: IoT Edge ゲートウェイのホスト名を設定する

この演習では**AZ-220-VM-EDGEGW-_{YOUR-ID}_**のパブリック IP アドレスの DNS 名を構成し、その DNS 名を IoT Edge ゲートウェイ デバイスの `hostname` として構成します。 

#### 演習 6: IoT Edge ゲートウェイ デバイスを IoT Hub に接続する

この演習では、IoT Edge デバイスを Azure IoT Hub に接続します。

#### 演習 7: 通信用に IoT Edge ゲートウェイ デバイス ポートを開く

この演習では、インターネットから Azure IoT Edge ゲートウェイへのアクセスをセキュリティで保護するネットワーク セキュリティ グループ (NSG) を構成します。ダウンストリーム IoT デバイスがゲートウェイと通信できるよう、MQTT、AMQP、および HTTPS 通信に必要なポートが開かれている必要があります。

Azure IoT Edge ゲートウェイが機能するには、少なくとも IoT Edge ハブでサポートされているプロトコルの 1 つが、ダウンストリーム デバイスからの受信トラフィックに対して開いている必要があります。サポートされるプロトコルは、MQTT、AMQP、および HTTPS です。

Azure IoT Edge によってサポートされる IoT 通信プロトコルには、次のポート マッピングがあります。

| プロトコル | ポート番号 |
| --- | --- |
| MQTT | 8883 年 |
| AMQP | 5671 年 |
| HTTPS<br/>MQTT + WS (Websocket)<br/>AMQP + WS (Websocket) | 443 年 |

デバイス用に選択された IoT 通信プロトコルは、IoT Edge ゲートウェイ デバイスを保護するファイアウォールに対し、対応するポートを開いている必要があります。このラボの場合は、IoT Edge ゲートウェイをセキュリティで保護するために Azure ネットワーク セキュリティ グループ (NSG) が使用されるため、NSG の受信セキュリティ規則は、これらのポートで開かれます。

運用シナリオでは、デバイスが通信するポートの最小数のみを開きます。MQTT を使用している場合は、インバウンド通信用にポート 8883 のみをオープンします。追加のポートを開くと、攻撃者が悪用する可能性がある追加のセキュリティ攻撃ベクトルが導入されます。セキュリティのベスト プラクティスとして、ソリューションに必要な最小数のポートのみを開く方法をお勧めします。

#### 演習 8: IoT Hub でダウンストリーム デバイス ID を作成する

この演習では、ダウンストリーム IoT デバイスの Azure IoT Hub に新しい IoT デバイス ID を作成します。このデバイス ID は、Azure IoT Edge ゲートウェイがこのダウンストリーム デバイスの親デバイスになるように構成されます。

#### 演習 9: ダウンストリーム デバイスを IoT Edge ゲートウェイに接続する

この演習では、IoT Edge ゲートウェイに接続するために事前に構築されたダウンストリーム デバイスを構成します。

#### エクササイズ 10: イベント フローの検証

この演習では、Azure CLI を使用して、IoT Edge ゲートウェイを経由してダウンストリーム IoT デバイスから Azure IoT Hub に送信されるイベントを監視します。これは、すべてが正しく動作していることを検証します。

## LAB_AK_13

### ラボ シナリオ

Contoso の倉庫は、コンベア ベルトで出荷するために梱包する準備ができている在庫を移動します。

製品の正しい量がパックされていることを確認するために、同じ IoT Edge デバイス上の別のオブジェクト検出モジュール (シミュレートされた) によってベルトで検出されたオブジェクトをカウントする単純なモジュールを追加します。オブジェクトカウントを行うカスタムモジュールを作成する方法を説明します。

このラボには、以下の開発マシン (ラボ ホスト環境 - VM または PC) の前提条件が含まれています。

* 次の拡張機能がインストールされた Visual Studio Code:
  * Microsoftの [Azure IoT Tools](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-tools)
  * Microsoftの [C#](https://marketplace.visualstudio.com/items?itemName=ms-vscode.csharp)
  * [ドッカー](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker)
* Docker Client バージョン 18.03.0 以降で、開発マシンにインストールされた Docker Community Edition
  * [Mac および Windows 用の Docker デスクトップをダウンロードする](https://www.docker.com/products/docker-desktop)

    > **重要**: 2020年1月13日に TLS バージョン 1.2 より前の TLS の Azure Container Registry のサポートが削除されたため、Docker クライアント 18.03.0 以降である必要があります。

#### 演習 1: ラボの前提条件を確認する

[tbd]

#### 演習 2: Azure IoT EdgeHub 開発ツールをインストールする

この演習では、Azure IoT EdgeHub 開発ツールをインストールします。

#### 演習 3: Azure Container Registry を作成する

Azure Container Registry は、コンテナーをデプロイするためのプライベート Docker イメージのストレージを提供します。このサービスは、オープンソースの Docker Registry 2.0 をベースとした、管理されたプライベートな Docker レジストリ サービスです。Azure Container Registry は、プライベート Docker コンテナー イメージを格納および管理するために使用されます。

この演習では、Azure portal を使用して、新しい Azure Container Registry リソースを作成します。

#### 演習 4: C\# でカスタム エッジ モジュールを作成する

この練習では、C# で記述されたカスタム Azure IoT Edge モジュールを含む Azure IoT Edge ソリューションを作成します。

#### 演習 5: IoT Edge シミュレータを使用した接続モードでのデバッグ

この演習では、Visual Studio Code内から IoT Edge シミュレーターを使用して、カスタム IoT Edge モジュール ソリューションをビルドして実行します。

#### 演習 6: IoT Edge ソリューションのデプロイ

この演習では、カスタム IoT Edge モジュールを構築して、Azure Container Registry (ACR) サービスに公開します。ACR に公開されると、カスタム モジュールは、任意のIoT Edge デバイスに展開できるようになります。

## LAB_AK_14

### ラボ シナリオ

コンベヤ ベルトシステムは、振動、テレメトリ、およびカウントオブジェクトを監視します。システムが、ネットワークの停止に対する耐性を持ち、1日の特定の時間にテレメトリ データの一括アップロード (負荷分散ネットワークの使用) を最適化することを望んでいます。ネットワークが落ちた場合に備えてオフラインをサポートするように IoT Edge を構成し、センサーからのテレメトリをローカルに格納し、指定の時間に定期的な同期を構成します。

IoT Edge デバイスがエンタープライズ ネットワーク上にある場合 (プロキシ設定が必要)、またはオフライン機能の拡張が必要な場合のさまざまなシナリオについて学習します。

#### 演習 1: ラボの前提条件を確認する

このラボでは、次のリソースが利用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| IoT デバイス | SimulatedThermostat |

#### 演習 2: Azure IoT Edge 対応 Linux VM をデプロイする

このユニットでは、Azure Marketplace から Azure IoT Edge ランタイム サポートを使用して Ubuntu サーバー VM をデプロイします。前のラボで、Azure portalを使用して VM を作成しました。今回は、Azure CLI を使用して VM を作成します。

#### 演習 3: 子 IoT デバイスを使用した 親 IoT Edge のセットアップ

この演習では、Azure IoT Hub 内の IoT Edge デバイスと、子の関係で構成されている IoT デバイスを登録します。これにより、クラウド内の Azure IoT Hub に通信する前に、子 IoT デバイスがゲートウェイとして IoT エッジ デバイスを介してメッセージを送信するシナリオが有効になります。

IoT Edge ゲートウェイ (親) と他の IoT デバイス (子またはリーフ デバイス) を含む親子関係を使用すると、Azure IoT ソリューション内でオフライン機能を使用できます。

次の図は、親としての Azure IoT Edge デバイスと子デバイスの関係を示しています。

![IoT Edge 親と子デバイスの図](images/IoTEdge-Parent-Child-Relationship.jpg "IoT Edge Parent with Child Device Diagram")

このシナリオでは、子デバイスは、Azure IoT Hub 認証情報を使用して、親の IoT Edge デバイスに接続して認証します。認証されると、子 IoT デバイスは、IoT Edge デバイス上のエッジ ハブ (`$edgeHub`) にメッセージを送信します。メッセージが親 IoT Edge デバイスに届くと、IoT Edge のモジュールとルーティングはメッセージを構成どおりに処理します。たとえば、接続時にはメッセージを Azure IoT Hub に送信します。

親 IoT Edge デバイスへの接続が切断されると (または Azure IoT Hub への接続が切れると)、すべてのデバイス メッセージが IoT Edgeデバイスに自動保存されます。接続が復元されると、IoT Edge デバイスも接続を再開し、保存されたメッセージをすべて Azure IoT Hub に送信します。IoT Edge デバイスに保存されたメッセージは、デバイスの存続時間 (TTL) 構成に応じて期限切れになる場合があります。デフォルトでは、メッセージを最大 `7200` 秒間 (2 時間) 保存します。

#### 演習 4: IoT Edge デバイスをゲートウェイとして構成する

この演習では、以前に作成した Ubuntu 仮想マシン上の Azure IoT Edge を IoT Edge 透過ゲートウェイ デバイスとして構成します。この構成は、プロセスをより迅速にするために、このユニットの一部であるヘルパー スクリプトによって処理されます。

#### 演習 5: Azure CLI を使用して IoT Edge ゲートウェイ デバイスの受信ポートを開く

この演習では、Azure CLI を使用して、インターネットから Azure IoT Edge ゲートウェイへのアクセスを保護するネットワーク セキュリティ グループ (NSG) を構成します。ダウンストリーム IoT デバイスがゲートウェイと通信できるよう、MQTT、AMQP、および HTTPS 通信に必要なポートが開かれている必要があります。

Azure IoT Edge ゲートウェイが子 IoT デバイスと通信するには、デバイス プロトコルの TCP/IP ポートが **受信**通信用に開かれていなくてはなりません。デバイスは、IoT ゲートウェイと通信するために、サポートされている 3つのプロトコルのいずれかを使用できます。

サポートされているプロトコルの TCP/IP ポート番号は次のとおりです。

| プロトコル | ポート番号 |
| --- | --- |
| MQTT | 8883 年 |
| AMQP | 5671 年 |
| HTTPS<br/>MQTT + WS (Websocket)<br/>AMQP + WS (Websocket) | 443 年 |

#### 演習 6: IoT Edge デバイスの Time-to-Live とメッセージ の記憶域を構成する

この演習では、Azure IoT Edge ゲートウェイ デバイス上の Edge ハブ モジュールのメッセージ Time-to-Live (TTL) が既定よりも長くなるように構成します。また、IoT Edge デバイス上でメッセージを保存するストレージの場所も構成します。

デフォルト値の `7200` (2 時間) は、長期間オフライン モードで機能する必要があるデバイスまたはソリューションには十分な長さではありません。デバイスとソリューションが切断状態で長時間動作するように、IoT Edge ハブモジュールの Time-to-Live (TTL) プロパティを 2 週間の TTL 期間の値である 1,209,600 秒に構成します。

IoT Edge ハブのモジュール ツインは `$edgeHub` と呼ばれ、デバイスで実行されている IoT Edge ハブと Azure IoT Hub サービス間の通信を調整するために使用されます。モジュール ツインの必要なプロパティ内にある、`storeAndForwardConfiguration.timeToLiveSecs` プロパティで、Azure IoT Hub などのルーティング エンドポイントから切断された状態のときに IoT Edge ハブがメッセージを保持する時間を秒単位で指定します。

単一デバイスまたは大規模なデプロイの一部である特定のデバイスの配置マニフェストで、Edge ハブの `timeToLiveSecs` プロパティを指定できます。この単元では、Azure IoT Hub の Azure portal ユーザー インターフェイスを使用して、単一の IoT Edge ゲートウェイ デバイスのエッジ ハブ「 `$edgeHub` 」モジュールの `timeToLiveSecs` プロパティを変更します。

#### 演習 7: 子 IoT デバイスを IoT Edge ゲートウェイに接続する

この演習では、構成済みの対称キーを使用して子 IoT デバイスを IoT ハブに接続するよう下位を構成します。デバイスは、親 IoT Edge デバイスのゲートウェイ ホスト名に加え、対称キーを含む接続文字列を使用して IoT ハブと親 IoT Edge デバイスに接続するように構成されます。

対称キーを使用して通常の IoT デバイスに対して IoT ハブを認証するプロセスは、ダウンストリーム (または子/リーフ) デバイスにも適用されます。唯一の違いは、接続をルーティングするゲートウェイ デバイスへのポインターを追加する必要があること、またはオフラインのシナリオでは、IoT ハブの代わりに認証を処理する必要がある点です。

前の単元で、Azure IoT Hub 上に IoT Device Identities を作成しました。IoT デバイスの**接続文字列**をコピーしました。  または、Azure portalを使用し、Azure IoT Hub 内にあるデバイスのデバイス ID への接続文字列にアクセスすることもできます。

#### 演習 8: デバイス接続とオフライン サポートのテスト

この演習では **ChildIoTDevice** から IoT Edge エッジ透過的ゲートウェイ **IoTEdgeGateway** を介して Azure IoT Hub に送信されるイベントを監視します。次に、**IoTEdgeGateway** と Azure IoT Hub の間の接続を中断し、テレメトリが子 IoT デバイスから IoT Edge ゲートウェイに今もなお送信されることを確認します。この後、Azure IoT Hub との接続を再開し、IoT Edge ゲートウェイが Azure IoT Hub への製品利用統計情報の送信を再開することを監視します。

## LAB_AK_15

### ラボ シナリオ

南部の場所でグルメチーズ製造会社を管理しているとします。同社はチーズ製造を誇りに思っており、チーズを成熟させるために使用される自然の洞窟の完璧な温度と湿度を維持するように注意しています。酒蔵には温度と湿度を報告するセンサーがあります。リモートオペレータは、必要に応じてファンを新しい設定に設定し、熟成チーズに最適な環境を維持することができます。ファンは加熱と冷却が可能で、加湿と除湿が可能です。

酒蔵は成熟したチーズ、その一定の温度、湿度、および空気の流れに使用され、プロセスにほぼ理想的な環境です。造られたセラーではなく、自然の洞窟でチーズ製品を熟成させる良質のものであることは言うまでもありません。製品ラベルに貼る何かです!

熟成チーズの理想的な温度は華氏50度(摂氏10度)で、どちらかの側は最大5度(2.78°C)で許容されます。湿度も重要です。最大飽和のパーセンテージで測定すると、75 から 95 % の湿度が問題ないと考えられます。85% を理想として設定し、10% の変動を許容可します。これらの値は、ほとんどのチーズに適用されます。チーズの皮の特定の条件など具体的な結果を達成するために、チーズメーカーは熟成中にこれらの値を調整します。

南の場所では、地表に近い自然の洞窟の周囲温度が約70度になることがあります。洞窟はまた、天井を通って浸透する水のために、100パーセント近くの相対湿度を持っている場合があります。これらの高い数字は、熟成チーズには良くない条件です。より北の場所では、自然の洞窟の周囲温度は理想的な 50 度になります。この場所のために、Azure IoT の助けが必要です。

#### テレメトリの送受信

製品利用統計情報の出力頻度は重要な要素です。冷凍ユニットの温度センサーは、毎分またはそれ以下の状態で報告する必要があります。航空機の加速度センサーは、少なくとも毎秒報告する必要があります。

IoT デバイスには 1 つ以上のセンサーが含まれ、いくつかの計算能力があります。IoT デバイスには LED ライト、そして小さなスクリーンが表示される場合があります。ただし、このデバイスは人間のオペレータによる直接使用を目的としていません。IoT デバイスは、クラウドから指示を受け取るように設計されています。

#### チーズケーブデバイスを制御する

このモジュールでは、IoT チーズ セラー監視デバイスに温度と湿度センサーがあると仮定します。デバイスは冷却または暖房、および加湿または脱加湿の両方が可能なファンを有します。数秒ごとに、デバイスは現在の温度と湿度の値を IoT Hub に送信します。この急速な頻度は、迅速な作業を必要とする場合のコード開発中を除いて、チーズ洞窟 (おそらく15分ごとかまたはそれ以下で、十分に粒状になる) にとって非現実的です!

このラボでは、ファンがオン、オフ、および失敗の 3つの状態のいずれかであると仮定します。ファンはオフ状態に初期化されます。後のユニットでは、ファンはダイレクト メソッドを使用してオンになります。

IoT デバイスのもう 1つの機能は、IoT Hub から必要な値を受け入れることです。デバイスは、これらの必要な値をターゲットにファンを調整できます。これらの値は、デバイス ツインと呼ばれる機能を使用してこのモジュールでコード化されています。必要な値は、デバイスの既定の設定をオーバーライドします。

#### サンプルのコーディング

このモジュールのコーディングは、テレメトリの送受信、ダイレクト メソッドの送受信、デバイス ツインの管理の 3つの部分に分かれています。

まず、テレメトリを受信するために、1つはデバイスがテレメトリを送信するためのアプリと、もう1つはクラウドで実行するバックエンド サービスの 2つのアプリを記述します。好みの言語 (Node.js または C#)、開発環境 (Visual Studio Code または Visual Studio) を選択できます。

#### 演習 1: IoT Hub ポータルを使用してカスタム Azure IoT Hub を作成する

このラボでは、次のリソースが利用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| IoT デバイス | CheeseCaveID |

#### 演習 2: テレメトリを送受信するコードを記述する

このユニットの最後で、テレメトリを送受信します。

#### 演習 2: テレメトリを受信する 2 つ目のアプリを作成する

これでテレメトリをポンプで送り出すデバイスが用意されましたが、IoT Hub にも接続されたバックエンド アプリでそのテレメトリを聞く必要があります。

#### 演習 3: ダイレクト メソッドを呼び出すコードを記述する

このユニットでは、ファンをオンにするダイレクト メソッドのコードをデバイス アプリに追加します。次に、このダイレクト メソッドを呼び出すコードをバックエンド サービス アプリに追加します。

直接メソッドを呼び出すバックエンド アプリからの呼び出しには、ペイロードの一部として複数のパラメーターを含めることができます。ダイレクト メソッドは、通常、デバイスの機能をオフまたはオンにしたり、デバイスの設定を指定したりするために使用します。

#### 演習 4: デバイス ツインのコードを書き込む

この演習では、デバイス アプリとバックエンド サービス アプリの両方に何らかのコードを追加して、操作中のデバイス ツイン同期を表示します。

デバイス ツインには、次の 4 種類の情報が含まれている点に留意してください。

* **タグ**: デバイスに表示されないデバイスの情報。
* **必要なプロパティ**: バックエンド アプリで指定された必要な設定。
* **報告されるプロパティ**: デバイスの設定の報告値。
* **デバイス ID のプロパティ**: デバイスを識別する読み取り専用情報。

デバイス ツインは、実際の IoT ハブ デバイスを使用してクエリを実行し、自動同期するように設計されています。デバイス ツインは、バックエンド アプリでいつでも照会できます。このクエリは、デバイスの現在の状態に関する情報を返すことができます。このデータを取得する場合、デバイスツインが自動的に同期するので、デバイスへの呼び出しは必要ありません。デバイス ツインの機能の多くは Azure IoT によって提供されるため、使用にあたりコードを記述する必要はほとんどありません。

デバイス ツインとダイレクト メソッドの機能には、いくつかの重複があります。直接的な方法で目的のプロパティを設定することができ、これは直感的な方法と思われます。ただし、ダイレクト メソッドを使用するには、アクセスする必要がある場合は、バックエンド アプリがこれらの設定を明示的に記録する必要があります。デバイス ツインを使用すると、この情報は既定で保存および管理されます。

## LAB_AK_16

### ラボ シナリオ

たとえばチーズ熟成庫の温湿度を最適なレベルで維持、および監視するソリューションを提供する会社を運営しているとします。あなたは長い間グルメチーズ製造会社と協力し、製品の品質を重視する顧客との長期的な信頼を確立してきました。

ソリューションは、温度や湿度をリアルタイムで報告する熟成庫に設置されたセンサーと空調システムで構成され、お客様はオンラインポータルから熟成庫に保管されているチーズの種類によって温度と湿度を調整したり、チーズを十分に熟成すべく環境を調整するためにデバイスを監視および遠隔操作できます。

あなたの会社は、顧客の様々な種類のチーズや、その貯蔵向けの多様なタイプの保管庫に適応するために、デバイス上で実行されているソフトウェアを常に改良しています。機能の更新に加えて、顧客の現場に展開されたデバイスに最新のセキュリティパッチが適用され、プライバシーの確保とハッカーがシステムを制御できないようにしたいと考えています。これを行うには、リモートでファームウェアを更新してデバイスを最新の状態に保つ必要があります。

#### 演習 1: Azure IoT Hub とデバイス ID を作成する

このラボでは、次のリソースが利用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | AZ-220-RG |
| IoT Hub | AZ-220-HUB-_{YOUR-ID}_ |
| IoT デバイス | SimulatedSolutionThermostat |

#### 演習 2: ファームウェアの更新を実装するデバイスをシミュレートするコードを記述します。

このタスクの最後に、IoT Hub からのファームウェアの更新要求を待っているデバイス シミュレーターがあります。

IoT デバイスでの最初のファームウェアの更新を開始する前に、そのような操作を実装する実際の意味と、Azure IoT Hub がプロセスの作成にどのように役立つかを確認してください。
##### IoT デバイスのファームウェアの更新は何を意味しますか。

IoTデバイスは、ほとんどの場合、最適化されたオペレーティングシステムによって電力を供給され、時には (実際のオペレーティング システムを必要とせずに) シリコン上で直接コードを実行することさえあります。この種のデバイスで実行されているソフトウェアを更新するために最も一般的な方法は、OSとその上で実行されているアプリ（ファームウェアと呼ばれる）を含む、ソフトウェアパッケージ全体の新しいバージョンをフラッシュすることです。

各デバイスには特定の目的があるため、ファームウェアは非常に限定的で、デバイスの目的だけでなく、利用可能な制約されたリソースにも最適化されています。

ファームウェアを更新するプロセスは、ハードウェア自体とハードウェアの製造元が行う方法に非常に固有のプロセスでもあります。これは、ファームウェアの更新プロセスの一部が汎用的ではないことを意味し、ファームウェアの更新プロセスの詳細を取得するためにデバイスの製造元と協力する必要があります (ファームウェアの更新プロセスを知っている可能性が高い独自のハードウェアを開発している場合を除きます)。

ファームウェアの更新プログラムはデバイスに手動で適用するために使用できますが、IoT ソリューションの規模の急激な拡大を考慮すると、この機能は実現できなくなりました。ファームウェアの更新プログラムは、クラウドからリモートで管理される新しいファームウェアの展開により、より一般的に無線 (OTA) で行われるようになりました。

IoT デバイスのすべての無線ファームウェア更新プログラムに共通の分母のセットがあります。

1. ファームウェアのバージョンは一意に識別されます
1. ファームウェアは、デバイスがオンライン ソースから取得する必要があるバイナリ ファイル形式で提供されます
1. ローカルに保存されているファームウェアは、何らかの形の物理ストレージです (ROM メモリ、ハードドライブなど)
1. デバイスの製造元は、ファームウェアを更新するために必要なデバイスの操作の説明を提供します。

##### Azure IoT Hub の自動デバイス管理

Azure IoT Hub は、単一およびデバイスのコレクションに対してデバイス管理操作を実装するための詳細なサポートを提供します。[自動デバイス管理](https://docs.microsoft.com/azure/iot-hub/iot-hub-auto-device-config)機能を使用すると、一連の操作を設定し、その操作をトリガーして実行を監視できます。 

この演習では、デバイス ツインの必要なプロパティの変更を管理し、ファームウェアの更新をシミュレートするローカル プロセスをトリガーする簡単なシミュレーターを作成します。実際のデバイスでは、ローカル ファームウェアの更新の実際の手順を除いて、全体のプロセスはまったく同じです。その後、Azure portal を使用して、1 つのデバイスのファームウェア更新プログラムを構成および実行します。IoT ハブは、デバイス ツインのプロパティを使用して、構成変更要求をデバイスに転送し、進行状況を監視します。

#### 演習 3: 単一のデバイスでファームウェアの更新をテストする

この演習では、Azure Portal を使用して新しいデバイス管理構成を作成し、単一のシミュレートされたデバイスに適用します。

## LAB_AK_17

### ラボ シナリオ

当社の資産トラッキング ソリューションは大きくなり、デバイスを 1 台ずつ (DPSを通じてでも) プロビジョニングしても拡張縮小できません。DPS と x.509 証明資格証認証を使用して、多くのデバイスを自動的かつ安全に登録します。当社のソリューションでは、センサーを使用して輸送中の資産を追跡します。センサーが輸送ボックスに追加されるたびに、DPS を介して自動プロビジョニングされます。ウェアハウス マネージャー用の"タグ付け"されたボックスの数を示すメトリックと、IoT Hub からのデバイス接続イベントの数が必要です。

このラボでは、ルート CA x.509 証明書チェーンを使用して、デバイス プロビジョニング サービス (DPS) 内のグループ登録をセットアップします。接続デバイスの数と送信テレメトリ メッセージを追跡し、接続イベントをログに送信するために、監視を使用するようにリンクされた IoT Hub を構成します。さらに、接続されているデバイスの平均数に基づいてトリガーされるアラートを作成します。ルート CA 証明書チェーンで生成されたデバイス CA 証明書を使用して、DPS で認証する 10 個のシミュレートされた IoT デバイスを構成します。IoT デバイスは、IoT ハブに製品利用統計情報を送信するように構成されます。

#### 演習 1: ラボの前提条件を確認する

[tbd]

#### 演習 2: IoT ハブを使用したメトリックと診断ログの設定と使用

運用中に実行されている IoT Hub ソリューションがある場合は、いくつかのメトリックを設定し、診断ログを有効にします。問題が発生した場合は、問題の診断と迅速な修正に役立つデータを確認できます。このラボでは、診断ログを有効にする方法と、エラーを確認する方法について説明します。また、監視するメトリックを設定し、メトリックが特定の境界に達したときに発生するアラートも設定します。

たとえば、接続デバイスの数が特定のしきい値を超えた場合や、使用されるメッセージ数が IoT Hub で 1日あたり許容されるメッセージのクォータに近づいた場合に、メールを送信できます。

#### 演習 3: ログ記録を有効にする

Azure リソース ログは、内部操作を記述する Azure リソースによって出力されるプラットフォーム ログです。すべてのリソース ログは、共通のトップレベル スキーマを共有し、各サービスが独自のイベントに対して一意のプロパティを出力する柔軟性を備えています。

#### 演習 4: アラートを設定する

次に、アラートを作成します。監視データに重要な状態が見つかった場合、アラートは事前に通知します。システムのユーザーが問題に気付く前に、問題を特定して対処できます。資産トラッキング シナリオでは、センサーを使用して、輸送中の資産を追跡します。センサーが輸送ボックスに追加されるたびに、DPS を介して自動プロビジョニングされます。倉庫マネージャーに「タグ付け」されたボックスの数を示すメトリックを設定し、IoT Hub からデバイスに接続されたイベントをカウントする必要があります。

このタスクでは、5つ以上のデバイスが接続されたときに倉庫マネージャーに通知するアラートを追加します。

#### 演習 5: センサーのシミュレーション

資産トラッキング シナリオの一部として、輸送中に資産を追跡するために使用されるタグをシミュレートするデバイスが必要です。各デバイスがアクティブ化されると、自動デバイス プロビジョニングを使用して IoT ソリューションに接続し、テレメトリの送信を開始する必要があります。自動的に接続するには、各デバイスが、グループ登録の作成に使用されるルート証明書へのチェーンの一部である独自の X509 証明書を必要とします。

このタスクでは、既存の環境を検証し、必要なセットアップを実行し、10個のデバイス証明書を生成し、10台のデバイスをシミュレートするコンソール アプリケーションを構成します。

#### 演習 6: デバイスのシミュレーション

このタスクでは、ルート証明書から X509 証明書を生成します。次に、DPS に接続して IoT Hub にテレメトリを送信する 10 のデバイスをシミュレートするコンソール アプリケーションで、これらの証明書を使用します。

#### 演習 7: メトリック、アラート、アーカイブの確認

[TBD]

## LAB_AK_18

**MISING**

## LAB_AK_19

### ラボ シナリオ

Contoso は、セキュリティを考慮してすべてのソリューションを構築しました。ただし、Azure IoT ソリューションを含め、オンプレミスとクラウドのすべてのワークロードでセキュリティに関する統一されたビューを得る方法を知りたいと考えています。さらに、新しいデバイスをオンボードする場合、セキュリティ標準への準拠とセキュリティ体制の向上を確実にするために、ワークロード (リーフ デバイス、Microsoft Edge デバイス、IoT Hub) にセキュリティ ポリシーを適用します。

Contoso は、新しい IoT デバイスを備えた新しいアセンブリ ラインを追加して、新しい注文に対する出荷と梱包の要求を増やすのに役立ちます。新しいデバイスがセキュリティで保護されていることを確認し、完全なエンドツーエンドの IoT ソリューションでソリューションのセキュリティを継続的に向上させるために、セキュリティに関する推奨事項を確認できるようにする必要があります。ソリューションに対する Azure IoT Center for IoT の使用について調査を開始します。

#### 演習 1: ラボの前提条件を確認する

[tbd]

#### 演習 2: Azure portal を使用して IoT ハブを作成する

このタスクでは、Azure portal を使用して IoT ハブ リソースを作成します。

#### 演習 3: Azure Security Center for IoT Hub を有効にする

IoT Hub の Azure Security Center は、セキュリティ管理を統一し、ハイブリッド クラウド ワークロードと Azure IoT ソリューション全体でエンド ツー エンドの脅威検出と分析を可能にします。

#### 演習 4: 新しいデバイスの作成と登録

[TBD]

#### 演習 5: セキュリティ モジュール ツインを作成する

Azure Security Center for IoT では、既存の IoT デバイス管理プラットフォームとの完全な統合が提供されるため、デバイスのセキュリティ状態を管理したり、既存のデバイス制御機能を使用したりできます。Azure Security Center for IoT 統合は、IoT Hub ツイン メカニズムを利用することによって実現します。

Azure Security Center for IoT は、モジュール ツイン メカニズムを使用し、各デバイスに対して azureiotsecurity という名前のセキュリティ モジュール ツインを保持します。

セキュリティ モジュール ツインは、各デバイスのデバイス セキュリティに関連するすべての情報を保持します。

IoT 機能用の Azure Security Center を最大限に活用するには、新しい IoT Edge デバイス用にこれらのセキュリティ モジュール ツインを作成、構成、使用する必要があります。

セキュリティ モジュール ツイン**azureiotsecurity**は、次の 2 つの方法で作成できます。 

* [モジュール バッチ スクリプト](https://github.com/Azure/Azure-IoT-Security/tree/master/security_module_twin) - は、デフォルトの構成を使用したモジュール ツインを使用せずに、新しいデバイスまたはデバイス類にモジュール ツインを自動的に作成します。
* 各デバイスの特定の構成で各モジュール ツインを個別に手動で編集します。

このタスクでは、セキュリティ モジュール ツインを手動で作成します。

#### 演習 6: Azure Security Center for IoT C# セキュリティ エージェントのデプロイ

IoT 用 Azure Security Center、IoT Hub を介してセキュリティ データをログに記録、処理、集計、送信するセキュリティ エージェント向けの参照アーキテクチャを提供します。シミュレートされたデバイス (Linux VM) にデプロイする C# のセキュリティ エージェントを追加します。C および C# ベースのエージェントがあります。C エージェントは、より制限されたまたは最小限のデバイス リソースを持つデバイスに推奨されます。

セキュリティ エージェントは、次の機能をサポートします。

* 基になるオペレーティング システム (Linux、Windows) から未加工のセキュリティ イベントを収集します。利用可能なセキュリティ データ コレクターの詳細については、「Azure Security Center for IoT エージェントの構成」に関するページを参照してください。
* 未加工のセキュリティ イベントを IoT ハブ経由で送信されるメッセージに集約します。
* 既存のデバイス ID または専用のモジュール ID で認証します。詳細については、「セキュリティ エージェントの認証方法」を参照してください。
* **azureiotsecurity** モジュール ツインを使って、リモートで構成します。詳細については、「Azure Security Center for IoT エージェントを構成する」を参照してください。

#### 演習 7: ソリューション管理の構成

Azure Security Center for IoT は、Azure ベースの IoT ソリューションに包括的なエンド ツー エンド のセキュリティを提供します。

Azure Security Center for IoT を使用すると、IoT ソリューション全体を 1 つのダッシュボードで監視し、すべての IoT デバイス、IoT プラットフォーム、および Azure のバックエンド リソースを表示できます。

IoT ハブで有効にすると、Azure Security Center for IoT は、IoT ハブに接続され、IoT ソリューションに関連する他の Azure サービスを自動的に識別します。

自動リレーションシップ検出に加えて、IoT ソリューションの一部としてタグ付けする他の Azure リソース グループを選択することもできます。選択すると、サブスクリプション全体、リソース グループ、または単一のリソースを追加できます。

## LAB_AK_20

### ラボ シナリオ

Azure IoT Central を使用すると、リモート デバイスのフリートを簡単に監視および管理できます。

Azure IoT Central には、とても役に立つさまざまな基盤テクノロジが含まれますが、多くのテクノロジが必要となる場合は、実装が複雑になる可能性があります。これらのテクノロジには、Azure IoT Hub、Azure Device Provisioning システム (DPS)、Azure Maps、Azure Time Series Insights、Azure IoT Edge などが含まれます。IoT Central を介して利用できるもの以上の細分性が必要な場合、これらのテクノロジを直接使用すれば十分です。

このラボの目的の 1 つは、必要になり得るシナリオをサポートするために IoT Central に十分な機能があるかどうかを、判断する役に立つことです。それでは、IoT Central が楽しく、複雑なシナリオで何ができるかを調査しましょう。

Contoso は、冷蔵トラックの車両を運営しています。市内に多数の顧客がおり、あなたが運営している拠点があります。その内容物を受け取り、任意の顧客にそれを届けるように、各トラックに指示します。ただし、冷却システムはいずれかのトラックで故障する可能性があり、内容物が溶融し始めた場合は、基地に戻るようにトラックに指示し、その後、内容物を廃棄するオプションが必要になります。または、内容物が溶けていることに気づいたら、トラックは近い別のお客様に内容物を届けることもできます。

これらの決定を下すためには、トラックで起こっているすべての最新の画像が必要です。マップ上の各トラックの位置、冷却システムの状態、および内容物の状態を知る必要があります。

IoT Central は、このシナリオを処理するために必要なすべてを提供します。 

#### 演習 1: カスタム IoT Central アプリを作成する

[TBD]

#### 演習 2: デバイス テンプレートを作成する

リモート デバイスと IoT Central の間で通信されるデータは、_デバイス テンプレート_で指定されます。デバイス テンプレートはデータの詳細をすべてカプセル化するため、通信を理解するために必要なすべてがデバイスと IoT Central の両方に備えられています。

このラボでは、冷凍トラック用のデバイス テンプレートを作成します。

#### 演習 3: シミュレートされたデバイスを監視する

まず、デバイス テンプレートのすべての機能を表示するダッシュボードを作成します。次に、実デバイスを作成し、リモート デバイス アプリに必要な接続設定を記録します。

#### 演習 4: 無料の Azure Maps アカウントを作成する

まだ Azure Maps アカウントをお持ちでない場合は、アカウントを作成する必要があります。

#### 演習 5: 実際のデバイスのプログラミング プロジェクトを作成する

このタスクでは、冷蔵トラックでセンサー デバイスをシミュレートするプログラミング プロジェクトを作成します。このシミュレーションでは、実際のトラックが必要になる前にコードをテストできます。

IoT Central は、デバイス アプリと IoT Central アプリ間の通信コードが実際のトラックで同じであるため、このシミュレーションを "リアル" として扱います。つまり、冷凍トラックの会社を経営している場合、このタスクのコードと同様のシミュレートされたコードから始めることになります。このコードが正常に動作した後、シミュレーション固有のコードはセンサー データを受け取るコードに置き換えられます。この限定的な更新により、次のコードを記述するという貴重なエクスペリエンスが得られます。

#### 演習 6: IoT Central デバイスをテストする

このタスクを通して作業することは、IoT Central 開発におけるすばらしい時間です。最後に、作成したすべての可動部品が連携しているかどうかを確認します。

#### 演習 7: 複数のデバイスを作成する

このタスクでは、複数のトラックをシステムに追加するために必要な手順を検討します。


